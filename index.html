<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Zashi Pay â€” Buy Shielded ZEC</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<style>
:root {
  --bg:        #080b0f;
  --surface:   #0e1318;
  --border:    #1c2530;
  --gold:      #f5c842;
  --gold-dim:  #c49e28;
  --teal:      #00e5c3;
  --teal-dim:  #00b39a;
  --text:      #e8edf2;
  --muted:     #5a6a7a;
  --danger:    #ff4d6a;
  --success:   #00e5c3;
  --radius:    12px;
  --font-head: 'Syne', sans-serif;
  --font-mono: 'Space Mono', monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ Background grid â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(0,229,195,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,229,195,.03) 1px,transparent 1px);
  background-size:40px 40px;
  pointer-events:none;z-index:0;
}

/* â”€â”€ NAV â”€â”€ */
nav{
  position:fixed;top:0;width:100%;z-index:100;
  display:flex;align-items:center;justify-content:space-between;
  padding:18px 40px;
  background:rgba(8,11,15,.85);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
}
.nav-logo{font-family:var(--font-head);font-size:22px;font-weight:800;letter-spacing:-0.5px;}
.nav-logo span{color:var(--gold);}
.nav-links{display:flex;gap:8px;}
.nav-link{
  padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;
  background:transparent;border:1px solid var(--border);color:var(--muted);
  font-family:var(--font-mono);transition:all .2s;text-decoration:none;
}
.nav-link:hover{border-color:var(--teal);color:var(--teal);}
.nav-link.active{background:var(--teal);color:#000;border-color:var(--teal);font-weight:700;}

/* â”€â”€ HERO â”€â”€ */
.hero{
  padding:140px 40px 60px;
  max-width:1100px;margin:0 auto;
  display:grid;grid-template-columns:1fr 1fr;gap:80px;align-items:center;
  position:relative;z-index:1;
}
.hero-label{
  font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--teal);
  margin-bottom:20px;display:flex;align-items:center;gap:8px;
}
.hero-label::before{content:'';width:24px;height:1px;background:var(--teal);}
.hero h1{
  font-family:var(--font-head);font-size:clamp(36px,4vw,58px);font-weight:800;
  line-height:1.05;letter-spacing:-1.5px;margin-bottom:24px;
}
.hero h1 em{color:var(--gold);font-style:normal;}
.hero-sub{color:var(--muted);font-size:14px;line-height:1.7;max-width:420px;}
.hero-stats{display:flex;gap:32px;margin-top:40px;}
.stat{border-left:2px solid var(--border);padding-left:16px;}
.stat-val{font-family:var(--font-head);font-size:22px;font-weight:700;color:var(--gold);}
.stat-label{font-size:11px;color:var(--muted);margin-top:2px;}

/* â”€â”€ MAIN CARD â”€â”€ */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:32px;position:relative;overflow:hidden;
}
.card::before{
  content:'';position:absolute;top:-60px;right:-60px;
  width:180px;height:180px;border-radius:50%;
  background:radial-gradient(circle,rgba(245,200,66,.08),transparent 70%);
  pointer-events:none;
}

/* â”€â”€ STEPS â”€â”€ */
.steps{
  max-width:1100px;margin:0 auto 60px;padding:0 40px;
  position:relative;z-index:1;
}
.steps-header{
  font-family:var(--font-head);font-size:11px;letter-spacing:3px;
  text-transform:uppercase;color:var(--muted);margin-bottom:24px;
}
.step-tabs{display:flex;gap:4px;margin-bottom:32px;border:1px solid var(--border);border-radius:10px;padding:4px;background:var(--bg);}
.step-tab{
  flex:1;padding:10px;text-align:center;border-radius:8px;font-size:12px;
  cursor:pointer;transition:all .2s;color:var(--muted);font-family:var(--font-mono);
  border:none;background:transparent;
}
.step-tab.active{background:var(--surface);color:var(--text);border:1px solid var(--border);}
.step-tab.done{color:var(--teal);}
.step-tab span{display:block;font-size:10px;margin-top:2px;opacity:.6;}

/* â”€â”€ STEP PANELS â”€â”€ */
.step-panel{display:none;}
.step-panel.active{display:block;animation:fadeIn .3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€ FORM ELEMENTS â”€â”€ */
.form-row{margin-bottom:20px;}
.form-row label{display:block;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.form-input{
  width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:var(--font-mono);font-size:14px;
  transition:border-color .2s;outline:none;
}
.form-input:focus{border-color:var(--teal);}
.form-input.error{border-color:var(--danger);}
.form-input::placeholder{color:var(--muted);}
.error-msg{color:var(--danger);font-size:11px;margin-top:6px;display:none;}
.error-msg.show{display:block;}

/* â”€â”€ AMOUNT INPUT â”€â”€ */
.amount-wrap{position:relative;}
.amount-wrap .currency{
  position:absolute;left:16px;top:50%;transform:translateY(-50%);
  color:var(--gold);font-weight:700;font-size:18px;
}
.amount-input{padding-left:36px;font-size:24px;font-weight:700;font-family:var(--font-head);}
.amount-presets{display:flex;gap:8px;margin-top:10px;}
.preset-btn{
  padding:6px 14px;border-radius:6px;font-size:12px;cursor:pointer;
  background:var(--bg);border:1px solid var(--border);color:var(--muted);
  font-family:var(--font-mono);transition:all .2s;
}
.preset-btn:hover,.preset-btn.active{background:var(--gold);color:#000;border-color:var(--gold);font-weight:700;}

/* â”€â”€ QUOTE BOX â”€â”€ */
.quote-box{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:16px;margin:20px 0;
}
.quote-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;}
.quote-row:not(:last-child){border-bottom:1px solid var(--border);}
.quote-label{font-size:12px;color:var(--muted);}
.quote-val{font-size:13px;font-weight:700;}
.quote-val.highlight{color:var(--teal);font-size:16px;}
.quote-val.fee{color:var(--gold);}
.quote-loading{text-align:center;color:var(--muted);font-size:12px;padding:8px;}

/* â”€â”€ PAYMENT METHOD TOGGLE â”€â”€ */
.pay-methods{display:flex;gap:8px;margin-bottom:24px;}
.pay-method-btn{
  flex:1;padding:14px;border-radius:8px;border:1px solid var(--border);
  background:var(--bg);color:var(--muted);font-family:var(--font-mono);
  font-size:12px;cursor:pointer;transition:all .2s;text-align:center;
}
.pay-method-btn:hover{border-color:var(--teal);color:var(--text);}
.pay-method-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(245,200,66,.05);}
.pay-method-btn .icon{font-size:20px;display:block;margin-bottom:4px;}
.pay-panel{display:none;}
.pay-panel.active{display:block;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  width:100%;padding:16px;border-radius:10px;font-family:var(--font-head);
  font-size:15px;font-weight:700;cursor:pointer;border:none;transition:all .2s;
  letter-spacing:.5px;position:relative;overflow:hidden;
}
.btn-primary{background:var(--gold);color:#000;}
.btn-primary:hover{background:var(--gold-dim);transform:translateY(-1px);}
.btn-primary:active{transform:translateY(0);}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-secondary{background:transparent;color:var(--teal);border:1px solid var(--teal);}
.btn-secondary:hover{background:rgba(0,229,195,.08);}
.btn-outline{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-outline:hover{border-color:var(--text);color:var(--text);}
.btn-plaid{background:linear-gradient(135deg,#0096FF,#0057b8);color:#fff;}
.btn-plaid:hover{opacity:.9;}
.btn-loading::after{
  content:'';position:absolute;inset:0;background:rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;
}

/* â”€â”€ STRIPE CARD ELEMENT â”€â”€ */
#stripe-card-element{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:14px 16px;transition:border-color .2s;
}
#stripe-card-element.StripeElement--focus{border-color:var(--teal);}
#stripe-card-element.StripeElement--invalid{border-color:var(--danger);}

/* â”€â”€ ADDRESS PREVIEW â”€â”€ */
.address-preview{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:12px 16px;font-size:11px;word-break:break-all;color:var(--teal);
  display:none;margin-top:8px;
}
.address-badge{
  display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
  border-radius:20px;font-size:10px;font-weight:700;letter-spacing:1px;
  margin-top:6px;
}
.badge-unified{background:rgba(0,229,195,.15);color:var(--teal);border:1px solid rgba(0,229,195,.3);}
.badge-sapling{background:rgba(245,200,66,.15);color:var(--gold);border:1px solid rgba(245,200,66,.3);}
.badge-transparent{background:rgba(90,106,122,.2);color:var(--muted);border:1px solid var(--border);}

/* â”€â”€ SUCCESS / CONFIRM â”€â”€ */
.success-panel{
  text-align:center;padding:40px 20px;display:none;
}
.success-panel.show{display:block;animation:fadeIn .4s ease;}
.success-icon{font-size:64px;margin-bottom:16px;}
.success-title{font-family:var(--font-head);font-size:28px;font-weight:800;color:var(--teal);margin-bottom:8px;}
.success-sub{color:var(--muted);font-size:13px;line-height:1.6;}
.tx-hash{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:12px;font-size:11px;word-break:break-all;color:var(--gold);
  margin-top:16px;
}

/* â”€â”€ TOAST â”€â”€ */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;}
.toast{
  padding:14px 20px;border-radius:10px;font-size:13px;min-width:260px;
  animation:slideIn .3s ease;display:flex;align-items:center;gap:10px;
  border:1px solid;
}
.toast-success{background:#0a1f1c;border-color:var(--teal);color:var(--teal);}
.toast-error{background:#1f0a0e;border-color:var(--danger);color:var(--danger);}
.toast-info{background:#1a1200;border-color:var(--gold);color:var(--gold);}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}

/* â”€â”€ SPINNER â”€â”€ */
.spinner{
  display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.2);
  border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ SECURITY BADGES â”€â”€ */
.security-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:24px;}
.sec-badge{
  display:flex;align-items:center;gap:6px;font-size:10px;color:var(--muted);
  border:1px solid var(--border);border-radius:6px;padding:6px 10px;
}
.sec-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--teal);}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px){
  .hero{grid-template-columns:1fr;gap:40px;padding:120px 20px 40px;}
  nav{padding:14px 20px;}
  .steps{padding:0 20px;}
  .hero-stats{gap:20px;}
}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-logo">ZASHI<span>PAY</span></div>
  <div class="nav-links">
    <a href="index.html" class="nav-link active">Buy ZEC</a>
    <a href="dashboard.html" class="nav-link">Dashboard</a>
    <a href="admin.html" class="nav-link">Admin</a>
  </div>
</nav>

<!-- HERO -->
<section class="hero">
  <div>
    <div class="hero-label">Privacy-First Payments</div>
    <h1>Buy <em>Shielded</em><br/>ZEC Instantly</h1>
    <p class="hero-sub">Pay with your bank account or credit card. ZEC is delivered directly to your Zashi unified address â€” fully shielded in the Orchard pool.</p>
    <div class="hero-stats">
      <div class="stat">
        <div class="stat-val" id="live-price">â€”</div>
        <div class="stat-label">ZEC/USD Price</div>
      </div>
      <div class="stat">
        <div class="stat-val">2%</div>
        <div class="stat-label">Platform Fee</div>
      </div>
      <div class="stat">
        <div class="stat-val">&lt;5 min</div>
        <div class="stat-label">Avg. Delivery</div>
      </div>
    </div>
  </div>

  <!-- PURCHASE CARD -->
  <div class="card">
    <!-- SUCCESS STATE -->
    <div class="success-panel" id="success-panel">
      <div class="success-icon">ğŸ›¡ï¸</div>
      <div class="success-title">ZEC Dispatched!</div>
      <div class="success-sub">Your shielded ZEC is on its way to your Zashi wallet.<br/>This may take up to 5 minutes to appear.</div>
      <div class="tx-hash" id="success-tx-hash">Transaction ID: â€”</div>
      <div style="margin-top:20px;">
        <button class="btn btn-secondary" onclick="resetFlow()">Buy More ZEC</button>
      </div>
    </div>

    <!-- MAIN FLOW -->
    <div id="main-flow">
      <!-- STEP TABS -->
      <div class="step-tabs">
        <button class="step-tab active" id="tab-1" onclick="goToStep(1)">
          1. Amount<span>How much?</span>
        </button>
        <button class="step-tab" id="tab-2" onclick="goToStep(2)">
          2. Address<span>Where?</span>
        </button>
        <button class="step-tab" id="tab-3" onclick="goToStep(3)">
          3. Payment<span>How to pay?</span>
        </button>
        <button class="step-tab" id="tab-4" onclick="goToStep(4)">
          4. Confirm<span>Review</span>
        </button>
      </div>

      <!-- STEP 1: AMOUNT -->
      <div class="step-panel active" id="step-1">
        <div class="form-row">
          <label>Amount (USD)</label>
          <div class="amount-wrap">
            <span class="currency">$</span>
            <input class="form-input amount-input" id="usd-amount" type="number" min="10" max="10000" placeholder="0.00" oninput="onAmountChange()"/>
          </div>
          <div class="amount-presets">
            <button class="preset-btn" onclick="setAmount(50)">$50</button>
            <button class="preset-btn" onclick="setAmount(100)">$100</button>
            <button class="preset-btn" onclick="setAmount(250)">$250</button>
            <button class="preset-btn" onclick="setAmount(500)">$500</button>
            <button class="preset-btn" onclick="setAmount(1000)">$1,000</button>
          </div>
          <div class="error-msg" id="amount-error">Please enter an amount between $10 and $10,000.</div>
        </div>
        <div class="quote-box" id="quote-box">
          <div class="quote-loading" id="quote-loading">Enter an amount to see your quote</div>
          <div id="quote-details" style="display:none;">
            <div class="quote-row">
              <span class="quote-label">You Pay</span>
              <span class="quote-val" id="q-gross">â€”</span>
            </div>
            <div class="quote-row">
              <span class="quote-label">Platform Fee (2%)</span>
              <span class="quote-val fee" id="q-fee">â€”</span>
            </div>
            <div class="quote-row">
              <span class="quote-label">ZEC Spot Price</span>
              <span class="quote-val" id="q-spot">â€”</span>
            </div>
            <div class="quote-row">
              <span class="quote-label">You Receive</span>
              <span class="quote-val highlight" id="q-zec">â€” ZEC</span>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" id="step1-next" onclick="validateStep1()" disabled>Continue â†’</button>
      </div>

      <!-- STEP 2: ZASHI ADDRESS -->
      <div class="step-panel" id="step-2">
        <div class="form-row">
          <label>Your Zashi Wallet Address</label>
          <input class="form-input" id="zashi-address" type="text" placeholder="u1... or zs... or t1..." oninput="onAddressChange()"/>
          <div class="address-preview" id="address-preview"></div>
          <div id="address-badge-wrap"></div>
          <div class="error-msg" id="address-error">Invalid Zcash address. Must start with u1 (Unified), zs (Sapling), or t1 (Transparent).</div>
        </div>
        <div class="form-row">
          <label>Your Email</label>
          <input class="form-input" id="user-email" type="email" placeholder="you@example.com" oninput="clearError('email-error')"/>
          <div class="error-msg" id="email-error">Please enter a valid email address.</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-outline" style="width:auto;padding:14px 20px;" onclick="goToStep(1)">â† Back</button>
          <button class="btn btn-primary" id="step2-next" onclick="validateStep2()" disabled>Continue â†’</button>
        </div>
      </div>

      <!-- STEP 3: PAYMENT METHOD -->
      <div class="step-panel" id="step-3">
        <div class="pay-methods">
          <button class="pay-method-btn active" id="pm-card" onclick="setPayMethod('card')">
            <span class="icon">ğŸ’³</span>Credit / Debit Card
          </button>
          <button class="pay-method-btn" id="pm-ach" onclick="setPayMethod('ach')">
            <span class="icon">ğŸ¦</span>Bank Account (ACH)
          </button>
          <button class="pay-method-btn" id="pm-wire" onclick="setPayMethod('wire')">
            <span class="icon">âš¡</span>Wire / RTP
          </button>
        </div>

        <!-- CARD PANEL -->
        <div class="pay-panel active" id="panel-card">
          <div class="form-row">
            <label>Card Details</label>
            <div id="stripe-card-element"></div>
            <div class="error-msg show" id="stripe-error" style="display:none;"></div>
          </div>
        </div>

        <!-- ACH PANEL -->
        <div class="pay-panel" id="panel-ach">
          <div class="form-row">
            <label>Link Your Bank Account</label>
            <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.6;">
              Securely connect your bank via Plaid. Your credentials are never shared with us.
            </p>
            <button class="btn btn-plaid" id="plaid-link-btn" onclick="initPlaidLink()">
              Connect Bank with Plaid
            </button>
            <div id="plaid-connected" style="display:none;margin-top:12px;">
              <div style="display:flex;align-items:center;gap:8px;color:var(--teal);font-size:13px;">
                âœ“ Bank account connected: <span id="plaid-bank-name" style="font-weight:700;"></span>
              </div>
            </div>
          </div>
          <div id="microdeposit-panel" style="display:none;">
            <div class="form-row">
              <label>Verify Micro-Deposits</label>
              <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">Check your bank for two small deposits and enter the amounts (in cents).</p>
              <div style="display:flex;gap:8px;">
                <input class="form-input" id="micro1" type="number" placeholder="e.g. 32" style="flex:1;"/>
                <input class="form-input" id="micro2" type="number" placeholder="e.g. 45" style="flex:1;"/>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="verifyMicroDeposits()">Verify Deposits</button>
          </div>
        </div>

        <!-- WIRE PANEL -->
        <div class="pay-panel" id="panel-wire">
          <div class="form-row">
            <label>Bank Details via Modern Treasury</label>
            <p style="font-size:12px;color:var(--muted);margin-bottom:16px;line-height:1.6;">
              Enter your bank routing and account numbers directly. Supports ACH, Wire, RTP, and FedNow rails.
            </p>
            <input class="form-input" id="mt-name" type="text" placeholder="Account Holder Name" style="margin-bottom:8px;"/>
            <input class="form-input" id="mt-routing" type="text" placeholder="Routing Number (9 digits)" maxlength="9" style="margin-bottom:8px;"/>
            <input class="form-input" id="mt-account" type="text" placeholder="Account Number" style="margin-bottom:8px;"/>
            <select class="form-input" id="mt-account-type" style="margin-bottom:8px;">
              <option value="checking">Checking</option>
              <option value="savings">Savings</option>
            </select>
            <button class="btn btn-secondary" onclick="registerMTCounterparty()">Verify Bank Details</button>
            <div id="mt-verified" style="display:none;margin-top:12px;color:var(--teal);font-size:13px;">
              âœ“ Bank details verified
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:16px;">
          <button class="btn btn-outline" style="width:auto;padding:14px 20px;" onclick="goToStep(2)">â† Back</button>
          <button class="btn btn-primary" id="step3-next" onclick="validateStep3()">Continue â†’</button>
        </div>
      </div>

      <!-- STEP 4: CONFIRM & SUBMIT -->
      <div class="step-panel" id="step-4">
        <div style="font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:20px;">Review Your Order</div>
        <div class="quote-box">
          <div class="quote-row">
            <span class="quote-label">Amount</span>
            <span class="quote-val" id="conf-amount">â€”</span>
          </div>
          <div class="quote-row">
            <span class="quote-label">Fee</span>
            <span class="quote-val fee" id="conf-fee">â€”</span>
          </div>
          <div class="quote-row">
            <span class="quote-label">ZEC to Receive</span>
            <span class="quote-val highlight" id="conf-zec">â€”</span>
          </div>
          <div class="quote-row">
            <span class="quote-label">Payment Method</span>
            <span class="quote-val" id="conf-method">â€”</span>
          </div>
          <div class="quote-row">
            <span class="quote-label">Destination</span>
            <span class="quote-val" id="conf-address" style="font-size:11px;word-break:break-all;max-width:200px;text-align:right;">â€”</span>
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);margin:16px 0;line-height:1.7;">
          By confirming, you agree to our Terms of Service. ZEC will be sent to your Zashi address after payment confirmation. Transactions are final.
        </div>
        <button class="btn btn-primary" id="confirm-btn" onclick="submitPayment()">
          <span id="confirm-btn-text">Confirm & Buy ZEC</span>
          <span id="confirm-spinner" style="display:none;"><span class="spinner"></span></span>
        </button>
        <button class="btn btn-outline" style="margin-top:8px;" onclick="goToStep(3)">â† Back</button>
      </div>
    </div><!-- /main-flow -->

    <!-- SECURITY BADGES -->
    <div class="security-row">
      <div class="sec-badge"><span class="dot"></span>256-bit TLS</div>
      <div class="sec-badge"><span class="dot"></span>Plaid Secured</div>
      <div class="sec-badge"><span class="dot"></span>Stripe PCI</div>
      <div class="sec-badge"><span class="dot"></span>Orchard Shielded</div>
    </div>
  </div><!-- /card -->
</section>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = 'http://localhost:3000';
const API_KEY  = 'YOUR_API_SECRET_KEY'; // Set this to your backend API key
const STRIPE_PK = 'pk_test_YOUR_STRIPE_PUBLISHABLE_KEY';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  step: 1,
  usdAmount: 0,
  zashiAddress: '',
  email: '',
  userId: 'user_' + Math.random().toString(36).substr(2,9),
  payMethod: 'card',
  quote: null,
  stripePaymentIntentId: null,
  stripeClientSecret: null,
  txId: null,
  plaidLinkToken: null,
  plaidBankToken: null,
  plaidCustomerId: null,
  plaidBankAccountId: null,
  plaidBankVerified: false,
  mtCounterpartyId: null,
  mtVerified: false,
  stripe: null,
  cardElement: null
};

// â”€â”€ STRIPE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initStripe() {
  state.stripe = Stripe(STRIPE_PK);
  const elements = state.stripe.elements({ appearance: { theme: 'night', variables: { colorPrimary: '#f5c842', fontFamily: 'Space Mono, monospace' } } });
  state.cardElement = elements.create('card', { style: { base: { color: '#e8edf2', fontFamily: 'Space Mono, monospace', fontSize: '14px' } } });
  state.cardElement.mount('#stripe-card-element');
  state.cardElement.on('change', e => {
    const el = document.getElementById('stripe-error');
    if (e.error) { el.textContent = e.error.message; el.style.display = 'block'; }
    else { el.style.display = 'none'; }
  });
}

// â”€â”€ FETCH LIVE ZEC PRICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLivePrice() {
  try {
    const res = await fetch(`${API_BASE}/api/gemini/spot-price`, { headers: { 'x-api-key': API_KEY } });
    const data = await res.json();
    document.getElementById('live-price').textContent = '$' + parseFloat(data.price).toFixed(2);
    return data.price;
  } catch(e) { return null; }
}

// â”€â”€ FETCH QUOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let quoteTimer;
async function onAmountChange() {
  clearTimeout(quoteTimer);
  const amount = parseFloat(document.getElementById('usd-amount').value);
  document.getElementById('step1-next').disabled = true;
  document.getElementById('quote-details').style.display = 'none';
  document.getElementById('quote-loading').textContent = 'Fetching live quote...';

  if (!amount || amount < 10 || amount > 10000) {
    document.getElementById('quote-loading').textContent = amount < 10 ? 'Minimum $10' : amount > 10000 ? 'Maximum $10,000' : 'Enter an amount to see your quote';
    return;
  }

  quoteTimer = setTimeout(async () => {
    try {
      const res = await fetch(`${API_BASE}/api/gemini/quote?amount_usd=${amount}`, { headers: { 'x-api-key': API_KEY } });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      state.quote = data;
      document.getElementById('q-gross').textContent = '$' + data.usdIn.toFixed(2);
      document.getElementById('q-fee').textContent   = '-$' + data.feeUsd.toFixed(2);
      document.getElementById('q-spot').textContent  = '$' + parseFloat(data.spotPrice).toFixed(2);
      document.getElementById('q-zec').textContent   = parseFloat(data.zecOut).toFixed(6) + ' ZEC';
      document.getElementById('quote-loading').style.display = 'none';
      document.getElementById('quote-details').style.display = 'block';
      document.getElementById('step1-next').disabled = false;
      // Clear presets
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    } catch(e) {
      document.getElementById('quote-loading').textContent = 'Error fetching quote. Check connection.';
    }
  }, 400);
}

function setAmount(val) {
  document.getElementById('usd-amount').value = val;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  onAmountChange();
}

// â”€â”€ ADDRESS VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onAddressChange() {
  const addr = document.getElementById('zashi-address').value.trim();
  const preview = document.getElementById('address-preview');
  const badgeWrap = document.getElementById('address-badge-wrap');
  const nextBtn = document.getElementById('step2-next');
  clearError('address-error');

  if (!addr) { preview.style.display='none'; badgeWrap.innerHTML=''; nextBtn.disabled=true; return; }

  let valid = false, badge = '', type = '';
  if (addr.startsWith('u1') && addr.length >= 43) {
    valid=true; type='Unified Address (Zashi Default)'; badge='badge-unified';
  } else if (addr.startsWith('zs') && addr.length >= 43) {
    valid=true; type='Sapling Shielded'; badge='badge-sapling';
  } else if (addr.startsWith('t1') && addr.length >= 34) {
    valid=true; type='Transparent (Not Shielded)'; badge='badge-transparent';
  }

  if (valid) {
    preview.textContent = addr;
    preview.style.display = 'block';
    badgeWrap.innerHTML = `<span class="address-badge ${badge}">${type}</span>`;
    clearError('address-error');
    checkEmailAndAddress();
  } else {
    preview.style.display='none';
    badgeWrap.innerHTML='';
    nextBtn.disabled=true;
    if (addr.length > 3) showError('address-error');
  }
}

function checkEmailAndAddress() {
  const addr  = document.getElementById('zashi-address').value.trim();
  const email = document.getElementById('user-email').value.trim();
  const validAddr  = (addr.startsWith('u1')||addr.startsWith('zs')||addr.startsWith('t1')) && addr.length>=34;
  const validEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  document.getElementById('step2-next').disabled = !(validAddr && validEmail);
}

// â”€â”€ PAYMENT METHOD SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPayMethod(method) {
  state.payMethod = method;
  ['card','ach','wire'].forEach(m => {
    document.getElementById('pm-'+m).classList.toggle('active', m===method);
    document.getElementById('panel-'+m).classList.toggle('active', m===method);
  });
}

// â”€â”€ STEP NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goToStep(n) {
  if (n > state.step) return; // Must validate forward
  state.step = n;
  document.querySelectorAll('.step-panel').forEach((p,i) => p.classList.toggle('active', i+1===n));
  document.querySelectorAll('.step-tab').forEach((t,i) => {
    t.classList.toggle('active', i+1===n);
    if (i+1 < n) t.classList.add('done'); else t.classList.remove('done');
  });
}

function advanceStep() {
  state.step++;
  goToStep(state.step);
}

// â”€â”€ STEP 1 VALIDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateStep1() {
  const amount = parseFloat(document.getElementById('usd-amount').value);
  if (!amount || amount < 10 || amount > 10000) { showError('amount-error'); return; }
  if (!state.quote) { toast('Please wait for quote to load', 'info'); return; }
  state.usdAmount = amount;
  advanceStep();
}

// â”€â”€ STEP 2 VALIDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateStep2() {
  const addr  = document.getElementById('zashi-address').value.trim();
  const email = document.getElementById('user-email').value.trim();
  if (!(addr.startsWith('u1')||addr.startsWith('zs')||addr.startsWith('t1'))||addr.length<34) {
    showError('address-error'); return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('email-error'); return; }
  state.zashiAddress = addr;
  state.email = email;
  advanceStep();
  initStripe();
  initPlaidLinkToken();
}

// â”€â”€ STEP 3 VALIDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateStep3() {
  if (state.payMethod === 'ach' && !state.plaidBankVerified) {
    toast('Please connect and verify your bank account first', 'error'); return;
  }
  if (state.payMethod === 'wire' && !state.mtVerified) {
    toast('Please verify your bank details first', 'error'); return;
  }
  // Populate confirm screen
  document.getElementById('conf-amount').textContent  = '$' + state.usdAmount.toFixed(2);
  document.getElementById('conf-fee').textContent     = '-$' + state.quote.feeUsd.toFixed(2);
  document.getElementById('conf-zec').textContent     = parseFloat(state.quote.zecOut).toFixed(6) + ' ZEC';
  document.getElementById('conf-method').textContent  = state.payMethod === 'card' ? 'Credit/Debit Card' : state.payMethod === 'ach' ? 'Bank (ACH/Plaid)' : 'Wire/RTP';
  document.getElementById('conf-address').textContent = state.zashiAddress.slice(0,12) + '...' + state.zashiAddress.slice(-6);
  advanceStep();
}

// â”€â”€ PLAID LINK INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initPlaidLinkToken() {
  try {
    const res = await apiFetch('/api/plaid/create-link-token', 'POST', { userId: state.userId });
    state.plaidLinkToken = res.link_token;
  } catch(e) { console.error('Plaid link token error:', e); }
}

async function initPlaidLink() {
  if (!state.plaidLinkToken) {
    toast('Initializing Plaid...', 'info');
    await initPlaidLinkToken();
  }
  const handler = Plaid.create({
    token: state.plaidLinkToken,
    onSuccess: async (public_token, metadata) => {
      const account = metadata.accounts[0];
      toast('Linking bank account...', 'info');
      try {
        const res = await apiFetch('/api/plaid/exchange-token', 'POST', {
          public_token, account_id: account.id
        });
        state.plaidBankToken = res.stripe_bank_account_token;
        // Create Stripe customer with this bank token
        const custRes = await apiFetch('/api/stripe/create-customer', 'POST', {
          email: state.email, name: state.email.split('@')[0],
          stripe_bank_account_token: state.plaidBankToken
        });
        state.plaidCustomerId    = custRes.customer_id;
        state.plaidBankAccountId = custRes.bank_account_id;
        document.getElementById('plaid-bank-name').textContent = account.name + ' Â·Â·Â·' + account.mask;
        document.getElementById('plaid-connected').style.display = 'block';
        document.getElementById('plaid-link-btn').style.display = 'none';
        // Show micro-deposit verification
        document.getElementById('microdeposit-panel').style.display = 'block';
        state.plaidBankVerified = true; // sandbox: auto-verified
        toast('Bank account linked! Verify micro-deposits to continue.', 'success');
      } catch(e) { toast('Failed to link bank: ' + e.message, 'error'); }
    },
    onExit: (err) => { if (err) toast('Plaid error: ' + err.display_message, 'error'); }
  });
  handler.open();
}

async function verifyMicroDeposits() {
  const amt1 = document.getElementById('micro1').value;
  const amt2 = document.getElementById('micro2').value;
  if (!amt1 || !amt2) { toast('Enter both micro-deposit amounts', 'error'); return; }
  try {
    const res = await apiFetch('/api/stripe/verify-bank', 'POST', {
      customer_id: state.plaidCustomerId, bank_account_id: state.plaidBankAccountId,
      amount1: parseInt(amt1), amount2: parseInt(amt2)
    });
    if (res.verified) {
      state.plaidBankVerified = true;
      toast('Bank account verified!', 'success');
      document.getElementById('microdeposit-panel').innerHTML = '<div style="color:var(--teal);font-size:13px;">âœ“ Bank account verified and ready</div>';
    } else {
      toast('Verification failed. Check the amounts.', 'error');
    }
  } catch(e) { toast('Verification error: ' + e.message, 'error'); }
}

// â”€â”€ MODERN TREASURY COUNTERPARTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registerMTCounterparty() {
  const name    = document.getElementById('mt-name').value.trim();
  const routing = document.getElementById('mt-routing').value.trim();
  const account = document.getElementById('mt-account').value.trim();
  const type    = document.getElementById('mt-account-type').value;
  if (!name || !routing || !account) { toast('Fill in all bank details', 'error'); return; }
  if (routing.length !== 9) { toast('Routing number must be 9 digits', 'error'); return; }
  try {
    const res = await apiFetch('/api/modern-treasury/create-counterparty', 'POST', {
      name, email: state.email, routing_number: routing, account_number: account, account_type: type
    });
    state.mtCounterpartyId = res.counterparty_id;
    state.mtVerified = true;
    document.getElementById('mt-verified').style.display = 'block';
    toast('Bank details verified!', 'success');
  } catch(e) { toast('Error: ' + e.message, 'error'); }
}

// â”€â”€ SUBMIT PAYMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitPayment() {
  const btn     = document.getElementById('confirm-btn');
  const btnText = document.getElementById('confirm-btn-text');
  const spinner = document.getElementById('confirm-spinner');
  btn.disabled  = true;
  btnText.style.display = 'none';
  spinner.style.display = 'inline';

  try {
    if (state.payMethod === 'card') {
      await submitCardPayment();
    } else if (state.payMethod === 'ach') {
      await submitAchPayment();
    } else if (state.payMethod === 'wire') {
      await submitWirePayment();
    }
  } catch(e) {
    toast('Payment failed: ' + e.message, 'error');
    btn.disabled = false;
    btnText.style.display = 'inline';
    spinner.style.display = 'none';
  }
}

async function submitCardPayment() {
  // Create payment intent on backend
  const pi = await apiFetch('/api/stripe/create-payment-intent', 'POST', {
    amount_usd: state.usdAmount, userId: state.userId,
    email: state.email, zashiAddress: state.zashiAddress
  });
  state.txId              = pi.txId;
  state.stripeClientSecret = pi.clientSecret;

  // Confirm card payment with Stripe.js
  const { error, paymentIntent } = await state.stripe.confirmCardPayment(pi.clientSecret, {
    payment_method: { card: state.cardElement, billing_details: { email: state.email } }
  });

  if (error) throw new Error(error.message);

  if (paymentIntent.status === 'succeeded') {
    // Webhook will trigger ZEC dispatch automatically
    // But also trigger manually in case webhook is delayed
    try {
      await apiFetch('/api/gemini/dispatch', 'POST', { txId: state.txId });
    } catch(_) {}
    showSuccess(pi.txId);
  }
}

async function submitAchPayment() {
  const res = await apiFetch('/api/stripe/charge-ach', 'POST', {
    customer_id: state.plaidCustomerId, bank_account_id: state.plaidBankAccountId,
    amount_usd: state.usdAmount, userId: state.userId,
    email: state.email, zashiAddress: state.zashiAddress
  });
  state.txId = res.txId;
  // ACH takes 1-3 days but ZEC dispatch happens on webhook
  toast('ACH initiated! ZEC will be sent when payment clears (1-3 business days).', 'success');
  showSuccess(res.txId, 'ACH payment initiated');
}

async function submitWirePayment() {
  const res = await apiFetch('/api/modern-treasury/ach-payment', 'POST', {
    counterparty_id: state.mtCounterpartyId, amount_usd: state.usdAmount,
    userId: state.userId, email: state.email, zashiAddress: state.zashiAddress
  });
  state.txId = res.txId;
  toast('Wire/ACH initiated via Modern Treasury!', 'success');
  showSuccess(res.txId, 'Wire payment initiated');
}

// â”€â”€ SUCCESS STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSuccess(txId, msg) {
  document.getElementById('main-flow').style.display = 'none';
  const panel = document.getElementById('success-panel');
  panel.style.display = 'block';
  panel.classList.add('show');
  document.getElementById('success-tx-hash').textContent = 'Transaction ID: ' + txId;
  toast(msg || 'ZEC dispatched to your Zashi wallet!', 'success');
}

function resetFlow() {
  state.step = 1;
  state.quote = null;
  state.txId  = null;
  document.getElementById('usd-amount').value = '';
  document.getElementById('zashi-address').value = '';
  document.getElementById('user-email').value = '';
  document.getElementById('address-preview').style.display = 'none';
  document.getElementById('address-badge-wrap').innerHTML = '';
  document.getElementById('quote-details').style.display = 'none';
  document.getElementById('quote-loading').textContent = 'Enter an amount to see your quote';
  document.getElementById('step1-next').disabled = true;
  document.getElementById('main-flow').style.display = 'block';
  document.getElementById('success-panel').style.display = 'none';
  goToStep(1);
}

// â”€â”€ API HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, method='GET', body=null) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API_BASE + path, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type='info') {
  const icons = { success:'âœ“', error:'âœ•', info:'â—†' };
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.innerHTML = `<span>${icons[type]}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// â”€â”€ ERROR HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(id)  { document.getElementById(id).classList.add('show'); }
function clearError(id) { document.getElementById(id).classList.remove('show'); }

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  fetchLivePrice();
  setInterval(fetchLivePrice, 30000); // refresh price every 30s
  document.getElementById('user-email').addEventListener('input', checkEmailAndAddress);
});
</script>
</body>
</html>
