<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X402 Protocol - Ultimate Payment Platform</title>
    
    <!-- REAL SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #00ff88; --secondary: #0088ff; --dark: #0a0e27; --darker: #050816;
            --card: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.1);
            --text: #fff; --text-dim: rgba(255,255,255,0.6);
            --error: #ff4444; --success: #00ff88; --warning: #ffaa00;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: var(--darker); color: var(--text); min-height: 100vh;
            background-image: radial-gradient(at 0% 0%, rgba(0, 255, 136, 0.1) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, rgba(0, 136, 255, 0.1) 0px, transparent 50%);
        }
        
        .topbar { 
            background: rgba(10, 14, 39, 0.95); backdrop-filter: blur(20px);
            padding: 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { 
            font-size: 24px; font-weight: 800; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .logo::before { content: '‚ö°'; margin-right: 10px; }
        
        .btn { 
            padding: 12px 24px; border-radius: 12px; border: none; 
            font-weight: 600; cursor: pointer; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: var(--dark); transition: all 0.3s; font-size: 14px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 255, 136, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 9999; 
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: var(--dark); border: 1px solid var(--border); border-radius: 20px; 
            padding: 40px; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .modal-header h2 { font-size: 24px; font-weight: 700; }
        .close-btn { 
            background: none; border: none; color: var(--text); font-size: 32px; 
            cursor: pointer; padding: 0; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; transition: all 0.3s; 
        }
        .close-btn:hover { background: var(--card); }
        
        .wallet-option { 
            display: flex; align-items: center; gap: 16px; padding: 20px; margin: 12px 0; 
            background: var(--card); border: 2px solid var(--border); border-radius: 16px; 
            cursor: pointer; transition: all 0.3s; 
        }
        .wallet-option:hover { 
            border-color: var(--primary); background: rgba(0,255,136,0.1); transform: translateX(4px);
        }
        .wallet-option.detected { border-color: var(--success); }
        .wallet-icon { 
            width: 56px; height: 56px; font-size: 36px; 
            display: flex; align-items: center; justify-content: center;
            background: var(--darker); border-radius: 12px;
        }
        .wallet-info { flex: 1; }
        .wallet-info h3 { font-size: 18px; margin-bottom: 4px; font-weight: 600; }
        .wallet-info p { font-size: 13px; color: var(--text-dim); }
        .wallet-status { 
            padding: 8px 16px; border-radius: 8px; font-size: 12px; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .wallet-status.detected { background: rgba(0,255,136,0.2); color: var(--success); }
        .wallet-status.not-detected { background: rgba(255,68,68,0.2); color: var(--error); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
        
        .tabs { display: flex; gap: 12px; margin: 30px 0; overflow-x: auto; padding-bottom: 10px; }
        .tab { 
            padding: 14px 28px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 12px; cursor: pointer; white-space: nowrap; 
            font-weight: 600; transition: all 0.3s; font-size: 15px;
        }
        .tab:hover { border-color: var(--primary); background: rgba(0,255,136,0.05); }
        .tab.active { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: var(--dark); border-color: transparent; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .cards { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
            gap: 24px; margin: 30px 0; 
        }
        .card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 20px; 
            padding: 30px; backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        .card:hover { border-color: rgba(0,255,136,0.3); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3); }
        .card h3 { font-size: 20px; margin-bottom: 24px; font-weight: 700; }
        
        .form-group { margin: 20px 0; }
        .form-group label { 
            display: block; margin-bottom: 10px; color: var(--text-dim); 
            font-size: 14px; font-weight: 600;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 14px; background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border); border-radius: 12px; color: var(--text); 
            font-size: 14px; transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
            background: rgba(255,255,255,0.08);
        }
        .form-group textarea { 
            resize: vertical; min-height: 100px; 
            font-family: 'Monaco', 'Courier New', monospace; font-size: 12px; 
        }
        
        .ticker { 
            display: flex; gap: 24px; padding: 20px; background: var(--card); 
            border: 1px solid var(--border); border-radius: 16px; margin: 30px 0; 
            overflow-x: auto; backdrop-filter: blur(20px);
        }
        .ticker-item { 
            display: flex; align-items: center; gap: 12px; white-space: nowrap;
            padding: 8px 16px; background: rgba(255,255,255,0.03); border-radius: 12px;
        }
        .ticker-symbol { font-weight: 700; font-size: 14px; }
        .price { font-weight: 700; color: var(--primary); font-size: 16px; }
        .change { font-size: 12px; padding: 4px 10px; border-radius: 6px; font-weight: 600; }
        .change.up { background: rgba(0,255,136,0.2); color: var(--success); }
        .change.down { background: rgba(255,68,68,0.2); color: var(--error); }
        
        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 24px; margin: 30px 0; 
        }
        .stat { 
            background: var(--card); border: 1px solid var(--border); border-radius: 20px; 
            padding: 28px; position: relative; overflow: hidden;
        }
        .stat::before {
            content: ''; position: absolute; top: 0; right: 0; width: 120px; height: 120px;
            background: var(--primary); opacity: 0.05; border-radius: 50%;
            transform: translate(30%, -30%);
        }
        .stat-value { 
            font-size: 36px; font-weight: 800; margin: 12px 0; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .stat-label { font-size: 14px; color: var(--text-dim); font-weight: 600; }
        
        .alert { 
            position: fixed; top: 90px; right: 20px; padding: 18px 24px; 
            background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 10000; 
            min-width: 300px; backdrop-filter: blur(20px);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .alert.success { border-color: var(--success); background: rgba(0,255,136,0.1); }
        .alert.error { border-color: var(--error); background: rgba(255,68,68,0.1); }
        .alert.warning { border-color: var(--warning); background: rgba(255,170,0,0.1); }
        
        .hidden { display: none !important; }
        
        .result-box { 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); 
            border-radius: 12px; padding: 20px; margin: 20px 0; 
            font-family: monospace; font-size: 12px; white-space: pre-wrap; 
            overflow-x: auto; max-height: 400px; overflow-y: auto;
        }
        
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-weight: 700; color: var(--text-dim); font-size: 12px; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.02); }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="topbar">
        <div class="logo">X402 PROTOCOL</div>
        <button id="walletBtn" class="btn">CONNECT WALLET</button>
    </div>

    <!-- WALLET MODAL -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Connect Wallet</h2>
                <button class="close-btn" onclick="closeWalletModal()">&times;</button>
            </div>
            <div id="walletList"></div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- PRICE TICKER -->
        <div id="ticker" class="ticker">
            <div style="color: var(--text-dim);">Loading prices...</div>
        </div>

        <!-- NAVIGATION TABS -->
        <div class="tabs">
            <div class="tab active" data-tab="payment">üí∏ Payment</div>
            <div class="tab" data-tab="deposit">üì• Deposit</div>
            <div class="tab" data-tab="zk">üîí ZK Private</div>
            <div class="tab" data-tab="privacy">üåê Privacy Route</div>
            <div class="tab" data-tab="sessions">‚è±Ô∏è Sessions</div>
            <div class="tab" data-tab="admin">‚öôÔ∏è Admin</div>
        </div>

        <!-- PAYMENT PAGE -->
        <div id="payment-page" class="page active">
            <div class="cards">
                <div class="card">
                    <h3>üí∏ Send USDC</h3>
                    <div class="form-group">
                        <label>Network</label>
                        <select id="usdcNet">
                            <option value="base">Base</option>
                            <option value="polygon">Polygon</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="arbitrum">Arbitrum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Recipient</label>
                        <input type="text" id="usdcRecipient" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="usdcAmt" placeholder="0.0" step="0.01" />
                    </div>
                    <button class="btn" onclick="sendUSDC()" style="width: 100%;">Send USDC</button>
                </div>

                <div class="card">
                    <h3>üîç Verify Zcash</h3>
                    <div class="form-group">
                        <label>Transaction Type</label>
                        <select id="zecType">
                            <option value="transparent">Transparent</option>
                            <option value="shielded">Shielded</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>TX Hash</label>
                        <input type="text" id="zecTx" placeholder="Transaction hash" />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="zecAmt" placeholder="0.0" step="0.01" />
                    </div>
                    <button class="btn" onclick="verifyZEC()" style="width: 100%;">Verify ZEC</button>
                </div>

                <div class="card">
                    <h3>üîí Verify Monero</h3>
                    <div class="form-group">
                        <label>Payment ID</label>
                        <input type="text" id="xmrId" placeholder="Payment ID" />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="xmrAmt" placeholder="0.0" step="0.01" />
                    </div>
                    <button class="btn" onclick="verifyXMR()" style="width: 100%;">Verify XMR</button>
                </div>
            </div>
        </div>

        <!-- DEPOSIT PAGE -->
        <div id="deposit-page" class="page">
            <div class="cards">
                <div class="card">
                    <h3>üì• Deposit USDC</h3>
                    <div class="form-group">
                        <label>Network</label>
                        <select id="depositNet" onchange="loadDepositAddress()">
                            <option value="base">Base</option>
                            <option value="polygon">Polygon</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deposit Address</label>
                        <input type="text" id="depositAddr" readonly />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="depositAmt" placeholder="0.0" />
                    </div>
                    <button class="btn" onclick="depositUSDC()" style="width: 100%;">Deposit</button>
                </div>
            </div>
        </div>

        <!-- ZK PRIVATE PAGE -->
        <div id="zk-page" class="page">
            <div class="cards">
                <div class="card">
                    <h3>ü™ô Mint Commitment</h3>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="mintAmt" placeholder="0.0" />
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="mintCur">
                            <option value="USDC">USDC</option>
                        </select>
                    </div>
                    <button class="btn" onclick="mint()" style="width: 100%;">Mint</button>
                    <div class="form-group">
                        <label>Secret (SAVE THIS!)</label>
                        <input type="text" id="mintSecret" readonly />
                    </div>
                    <div id="mintRes" class="result-box hidden"></div>
                </div>

                <div class="card">
                    <h3>üîÑ Private Transfer</h3>
                    <div class="form-group">
                        <label>Commitment</label>
                        <input type="text" id="transferComm" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Secret</label>
                        <input type="text" id="transferSecret" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="transferAmt" placeholder="0.0" />
                    </div>
                    <button class="btn" onclick="transfer()" style="width: 100%;">Transfer</button>
                    <div id="transferRes" class="result-box hidden"></div>
                </div>

                <div class="card">
                    <h3>üí∞ Withdraw</h3>
                    <div class="form-group">
                        <label>Commitment</label>
                        <input type="text" id="withdrawComm" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Secret</label>
                        <input type="text" id="withdrawSecret" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="withdrawAmt" placeholder="0.0" />
                    </div>
                    <div class="form-group">
                        <label>Recipient</label>
                        <input type="text" id="withdrawRecipient" placeholder="0x..." />
                    </div>
                    <button class="btn" onclick="withdraw()" style="width: 100%;">Withdraw</button>
                    <div id="withdrawRes" class="result-box hidden"></div>
                </div>
            </div>
        </div>

        <!-- PRIVACY ROUTE PAGE -->
        <div id="privacy-page" class="page">
            <div class="cards">
                <div class="card">
                    <h3>üåê Privacy Routing</h3>
                    <div class="form-group">
                        <label>Source Chain</label>
                        <select id="privSrc">
                            <option value="ethereum">Ethereum</option>
                            <option value="polygon">Polygon</option>
                            <option value="base">Base</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source TX Hash</label>
                        <input type="text" id="privTx" placeholder="0x..." />
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="privAmt" placeholder="0.0" />
                    </div>
                    <div class="form-group">
                        <label>Destination Chain</label>
                        <select id="privDest">
                            <option value="ethereum">Ethereum</option>
                            <option value="polygon">Polygon</option>
                            <option value="base">Base</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Destination Address</label>
                        <input type="text" id="privAddr" placeholder="0x..." />
                    </div>
                    <button class="btn" onclick="routePrivacy()" style="width: 100%;">Route</button>
                    <div id="privStatus" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- SESSIONS PAGE -->
        <div id="sessions-page" class="page">
            <div class="cards">
                <div class="card">
                    <h3>‚è±Ô∏è Create Session</h3>
                    <div class="form-group">
                        <label>Balance</label>
                        <input type="number" id="sessBal" placeholder="Minimum $10" />
                    </div>
                    <div class="form-group">
                        <label>Commitment (optional)</label>
                        <input type="text" id="sessComm" placeholder="0x..." />
                    </div>
                    <button class="btn" onclick="createSession()" style="width: 100%;">Create</button>
                    <div id="sessRes" class="result-box hidden"></div>
                </div>
            </div>
        </div>

        <!-- ADMIN PAGE -->
        <div id="admin-page" class="page">
            <div id="adminLogin" class="cards">
                <div class="card">
                    <h3>üîê Admin Login</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="adminUser" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="adminPass" />
                    </div>
                    <button class="btn" onclick="adminLogin()" style="width: 100%; margin-bottom: 10px;">Login</button>
                    <button class="btn btn-secondary" onclick="adminSetup()" style="width: 100%;">Setup</button>
                </div>
            </div>

            <div id="adminDash" class="hidden">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Revenue</div>
                        <div class="stat-value" id="statRev">$0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Payments</div>
                        <div class="stat-value" id="statPay">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Sessions</div>
                        <div class="stat-value" id="statSess">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Commitments</div>
                        <div class="stat-value" id="statComm">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üí∏ Recent Payments</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Currency</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payTable"></tbody>
                    </table>
                </div>

                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3402/api/v2';
        
        // GLOBAL STATE
        let provider = null;
        let signer = null;
        let wallet = null;
        let token = null;
        let selectedWalletName = '';

        // USDC CONTRACT ADDRESSES (REAL)
        const USDC_ADDRESSES = {
            base: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
            polygon: '0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359',
            ethereum: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
            arbitrum: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831'
        };

        const USDC_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function balanceOf(address owner) view returns (uint256)',
            'function decimals() view returns (uint8)'
        ];

        // ==================== WALLET DETECTION (REAL EIP-1193) ====================
        function detectWallets() {
            console.log('==================== WALLET DETECTION START ====================');
            console.log('üîç Checking for window.ethereum...');
            
            const wallets = [];
            
            if (!window.ethereum) {
                console.log('‚ùå No window.ethereum found');
                console.log('window.ethereum:', window.ethereum);
                console.log('User needs to install a wallet extension');
                return wallets;
            }

            console.log('‚úÖ window.ethereum exists:', window.ethereum);
            console.log('window.ethereum properties:', Object.keys(window.ethereum));
            
            // Check for EIP-6963 providers (new multi-injector standard)
            if (window.ethereum.providers && Array.isArray(window.ethereum.providers)) {
                console.log(`‚úÖ EIP-6963 detected: ${window.ethereum.providers.length} providers`);
                window.ethereum.providers.forEach((prov, idx) => {
                    console.log(`Provider ${idx}:`, {
                        isMetaMask: prov.isMetaMask,
                        isTokenPocket: prov.isTokenPocket,
                        isTrust: prov.isTrust,
                        isCoinbaseWallet: prov.isCoinbaseWallet,
                        isBraveWallet: prov.isBraveWallet,
                        isOKExWallet: prov.isOKExWallet
                    });
                });
            } else {
                console.log('‚ÑπÔ∏è No EIP-6963 providers array, using single provider');
            }
            
            // Get all providers
            const providers = window.ethereum.providers || [window.ethereum];
            console.log(`üì¶ Total providers to check: ${providers.length}`);

            // MetaMask (exclude Brave to avoid conflicts)
            const metamask = providers.find(p => p.isMetaMask && !p.isBraveWallet);
            if (metamask) {
                wallets.push({ 
                    name: 'MetaMask', 
                    icon: 'ü¶ä', 
                    provider: metamask, 
                    detected: true 
                });
                console.log('‚úÖ MetaMask detected');
            } else {
                console.log('‚ùå MetaMask not detected');
            }

            // TokenPocket
            const tokenpocket = providers.find(p => p.isTokenPocket);
            if (tokenpocket) {
                wallets.push({ 
                    name: 'TokenPocket', 
                    icon: 'üíº', 
                    provider: tokenpocket, 
                    detected: true 
                });
                console.log('‚úÖ TokenPocket detected');
            } else {
                console.log('‚ùå TokenPocket not detected');
            }

            // Trust Wallet
            const trust = providers.find(p => p.isTrust);
            if (trust) {
                wallets.push({ 
                    name: 'Trust Wallet', 
                    icon: 'üõ°Ô∏è', 
                    provider: trust, 
                    detected: true 
                });
                console.log('‚úÖ Trust Wallet detected');
            } else {
                console.log('‚ùå Trust Wallet not detected');
            }

            // Coinbase Wallet
            const coinbase = providers.find(p => p.isCoinbaseWallet);
            if (coinbase) {
                wallets.push({ 
                    name: 'Coinbase Wallet', 
                    icon: 'üî∑', 
                    provider: coinbase, 
                    detected: true 
                });
                console.log('‚úÖ Coinbase Wallet detected');
            } else {
                console.log('‚ùå Coinbase Wallet not detected');
            }

            // Brave Wallet
            const brave = providers.find(p => p.isBraveWallet);
            if (brave) {
                wallets.push({ 
                    name: 'Brave Wallet', 
                    icon: 'ü¶Å', 
                    provider: brave, 
                    detected: true 
                });
                console.log('‚úÖ Brave Wallet detected');
            } else {
                console.log('‚ùå Brave Wallet not detected');
            }

            // OKX Wallet
            const okx = providers.find(p => p.isOKExWallet || p.isOkxWallet);
            if (okx) {
                wallets.push({ 
                    name: 'OKX Wallet', 
                    icon: '‚≠ï', 
                    provider: okx, 
                    detected: true 
                });
                console.log('‚úÖ OKX Wallet detected');
            } else {
                console.log('‚ùå OKX Wallet not detected');
            }

            // Fallback: if no specific wallet detected but window.ethereum exists
            if (wallets.length === 0 && window.ethereum) {
                console.log('‚ö†Ô∏è No specific wallet detected, using generic window.ethereum');
                wallets.push({ 
                    name: 'Browser Wallet', 
                    icon: 'üåê', 
                    provider: window.ethereum, 
                    detected: true 
                });
                console.log('‚úÖ Generic browser wallet added');
            }

            console.log(`‚úÖ Total wallets detected: ${wallets.length}`);
            wallets.forEach((w, idx) => {
                console.log(`  ${idx}: ${w.name} ${w.icon}`);
            });
            console.log('==================== WALLET DETECTION END ====================');
            
            return wallets;
        }

        function showWalletModal() {
            console.log('==================== SHOWING WALLET MODAL ====================');
            
            const wallets = detectWallets();
            const list = document.getElementById('walletList');

            console.log('Wallets to display:', wallets.length);

            if (wallets.length === 0) {
                console.log('‚ö†Ô∏è No wallets found, showing install message');
                list.innerHTML = `
                    <div style="text-align:center;padding:50px;color:var(--text-dim);">
                        <div style="font-size: 48px; margin-bottom: 20px;">üòî</div>
                        <h3>No Wallets Detected</h3>
                        <p style="margin: 20px 0;">Please install MetaMask, TokenPocket, or another Web3 wallet</p>
                        <button class="btn" onclick="window.open('https://metamask.io/download/', '_blank')" style="margin-top: 20px;">
                            Install MetaMask
                        </button>
                    </div>
                `;
            } else {
                console.log('‚úÖ Rendering wallet options');
                
                // Store wallets globally FIRST
                window.detectedWallets = wallets;
                console.log('‚úÖ Wallets stored in window.detectedWallets:', window.detectedWallets);
                
                // Generate HTML
                const html = wallets.map((w, idx) => {
                    console.log(`Creating option for wallet ${idx}: ${w.name}`);
                    return `
                        <div class="wallet-option detected" onclick='connectWallet(${idx})' style="cursor: pointer;">
                            <div class="wallet-icon">${w.icon}</div>
                            <div class="wallet-info">
                                <h3>${w.name}</h3>
                                <p>EIP-1193 Compatible</p>
                            </div>
                            <div class="wallet-status detected">‚úì DETECTED</div>
                        </div>
                    `;
                }).join('');
                
                list.innerHTML = html;
                console.log('‚úÖ Wallet options rendered');
            }

            // Show modal
            const modal = document.getElementById('walletModal');
            modal.classList.add('active');
            console.log('‚úÖ Modal displayed');
            console.log('==================== WALLET MODAL SHOWN ====================');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('active');
        }

        // ==================== WALLET CONNECTION (REAL EIP-1193) ====================
        async function connectWallet(walletIndex) {
            try {
                console.log('==================== STARTING WALLET CONNECTION ====================');
                console.log('Wallet index:', walletIndex);
                console.log('Available wallets:', window.detectedWallets);

                const walletObj = window.detectedWallets[walletIndex];
                if (!walletObj) {
                    console.error('‚ùå Wallet object not found at index', walletIndex);
                    showAlert('Wallet not found!', 'error');
                    return;
                }

                console.log('üîÑ Connecting to:', walletObj.name);
                console.log('Provider object:', walletObj.provider);
                console.log('Provider methods:', Object.keys(walletObj.provider));
                
                showAlert(`Connecting to ${walletObj.name}...`, 'warning');

                // Verify provider has request method
                if (!walletObj.provider.request) {
                    console.error('‚ùå Provider does not have request method!');
                    throw new Error('Wallet provider is not EIP-1193 compatible');
                }

                // Request accounts using EIP-1193
                console.log('üì° Calling eth_requestAccounts...');
                let accounts;
                try {
                    accounts = await walletObj.provider.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    console.log('‚úÖ eth_requestAccounts response:', accounts);
                } catch (requestError) {
                    console.error('‚ùå eth_requestAccounts failed:', requestError);
                    if (requestError.code === 4001) {
                        throw new Error('User rejected the connection request');
                    }
                    throw new Error(`Request failed: ${requestError.message}`);
                }

                if (!accounts || accounts.length === 0) {
                    console.error('‚ùå No accounts returned');
                    throw new Error('No accounts returned from wallet');
                }

                console.log('‚úÖ Got accounts:', accounts);
                console.log('‚úÖ Selected account:', accounts[0]);

                // Create ethers provider and signer
                console.log('üì° Creating ethers.js provider...');
                try {
                    provider = new ethers.providers.Web3Provider(walletObj.provider);
                    console.log('‚úÖ Provider created:', provider);
                    
                    signer = provider.getSigner();
                    console.log('‚úÖ Signer created:', signer);
                    
                    wallet = accounts[0];
                    selectedWalletName = walletObj.name;
                    console.log('‚úÖ Wallet address set:', wallet);
                } catch (ethersError) {
                    console.error('‚ùå Ethers.js error:', ethersError);
                    throw new Error(`Failed to create provider: ${ethersError.message}`);
                }

                // Get network
                console.log('üì° Getting network info...');
                let network;
                try {
                    network = await provider.getNetwork();
                    console.log('‚úÖ Connected to network:', network.name, 'chainId:', network.chainId);
                } catch (networkError) {
                    console.error('‚ö†Ô∏è Network detection failed (non-critical):', networkError);
                }

                // Update UI
                console.log('üé® Updating UI...');
                const btn = document.getElementById('walletBtn');
                btn.textContent = `${walletObj.icon} ${wallet.slice(0,6)}...${wallet.slice(-4)}`;
                btn.style.background = 'var(--card)';
                btn.style.color = 'var(--primary)';
                btn.style.border = '2px solid var(--primary)';
                console.log('‚úÖ UI updated');

                closeWalletModal();
                showAlert(`‚úÖ Connected to ${walletObj.name}!`, 'success');
                console.log('‚úÖ CONNECTION SUCCESSFUL');

                // Setup event listeners
                console.log('üì° Setting up event listeners...');
                try {
                    if (walletObj.provider.on) {
                        walletObj.provider.on('accountsChanged', (accounts) => {
                            console.log('üîÑ Accounts changed event:', accounts);
                            if (accounts.length === 0) {
                                wallet = null;
                                provider = null;
                                signer = null;
                                btn.textContent = 'CONNECT WALLET';
                                btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                                btn.style.color = 'var(--dark)';
                                btn.style.border = 'none';
                                showAlert('Wallet disconnected', 'warning');
                            } else {
                                wallet = accounts[0];
                                btn.textContent = `${walletObj.icon} ${wallet.slice(0,6)}...${wallet.slice(-4)}`;
                                showAlert('Account changed', 'warning');
                            }
                        });

                        walletObj.provider.on('chainChanged', (chainId) => {
                            console.log('üîÑ Chain changed event:', chainId);
                            showAlert('Network changed - please refresh', 'warning');
                            setTimeout(() => window.location.reload(), 2000);
                        });
                        console.log('‚úÖ Event listeners registered');
                    } else {
                        console.warn('‚ö†Ô∏è Provider does not support event listeners');
                    }
                } catch (eventError) {
                    console.error('‚ö†Ô∏è Event listener setup failed (non-critical):', eventError);
                }

                // Load deposit addresses
                console.log('üì° Loading deposit addresses...');
                try {
                    await loadDepositAddress();
                    console.log('‚úÖ Deposit addresses loaded');
                } catch (depositError) {
                    console.error('‚ö†Ô∏è Deposit address load failed (non-critical):', depositError);
                }

                console.log('==================== WALLET CONNECTION COMPLETE ====================');

            } catch (error) {
                console.error('==================== WALLET CONNECTION FAILED ====================');
                console.error('‚ùå Connection error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Full error object:', JSON.stringify(error, null, 2));
                
                showAlert(`Connection failed: ${error.message}`, 'error');
            }
        }

        // ==================== PAYMENT FUNCTIONS (REAL TRANSACTIONS) ====================
        async function sendUSDC() {
            if (!signer) {
                showAlert('Connect wallet first!', 'error');
                showWalletModal();
                return;
            }

            const network = document.getElementById('usdcNet').value;
            const amount = parseFloat(document.getElementById('usdcAmt').value);
            const recipient = document.getElementById('usdcRecipient').value;

            if (!amount || amount <= 0) {
                showAlert('Enter valid amount!', 'error');
                return;
            }

            if (!recipient || !recipient.startsWith('0x')) {
                showAlert('Enter valid recipient address!', 'error');
                return;
            }

            try {
                showAlert('Preparing USDC transfer...', 'warning');

                const usdcAddress = USDC_ADDRESSES[network];
                if (!usdcAddress) {
                    throw new Error(`Network ${network} not supported`);
                }

                // Get network info
                const currentNetwork = await provider.getNetwork();
                console.log('Current network:', currentNetwork);

                // Create contract instance
                const usdcContract = new ethers.Contract(usdcAddress, USDC_ABI, signer);

                // Get decimals
                const decimals = await usdcContract.decimals();
                console.log('USDC decimals:', decimals);

                // Parse amount
                const amountToSend = ethers.utils.parseUnits(amount.toString(), decimals);
                console.log('Amount to send:', amountToSend.toString());

                // Check balance
                const balance = await usdcContract.balanceOf(wallet);
                console.log('Current balance:', ethers.utils.formatUnits(balance, decimals));

                if (balance.lt(amountToSend)) {
                    const available = ethers.utils.formatUnits(balance, decimals);
                    throw new Error(`Insufficient USDC. Available: ${available}, Required: ${amount}`);
                }

                // Send transaction
                showAlert('Please confirm in wallet...', 'warning');
                const tx = await usdcContract.transfer(recipient, amountToSend);
                
                console.log('Transaction sent:', tx.hash);
                showAlert(`Transaction sent: ${tx.hash.slice(0, 10)}...`, 'warning');

                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('Transaction confirmed:', receipt);

                showAlert('‚úÖ USDC transfer confirmed!', 'success');
                document.getElementById('usdcAmt').value = '';
                document.getElementById('usdcRecipient').value = '';

                // Notify backend
                try {
                    await fetch(API + '/payments/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            txHash: tx.hash,
                            from: wallet,
                            to: recipient,
                            amount: amount,
                            currency: 'USDC',
                            network: network
                        })
                    });
                } catch (e) {
                    console.log('Backend notification failed (non-critical):', e);
                }

            } catch (error) {
                console.error('Payment error:', error);
                showAlert('Payment failed: ' + error.message, 'error');
            }
        }

        async function verifyZEC() {
            const txid = document.getElementById('zecTx').value;
            const amount = parseFloat(document.getElementById('zecAmt').value);
            const type = document.getElementById('zecType').value;

            if (!txid || !amount) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Verifying Zcash payment...', 'warning');

                const response = await fetch(API + '/payments/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currency: 'ZEC',
                        proof: txid,
                        amount: amount,
                        type: type,
                        clientId: wallet
                    })
                });

                const data = await response.json();

                if (data.verified) {
                    showAlert('‚úì Zcash payment verified!', 'success');
                    document.getElementById('zecTx').value = '';
                    document.getElementById('zecAmt').value = '';
                } else {
                    showAlert('‚úó Verification failed', 'error');
                }
            } catch (error) {
                showAlert('Verification failed: ' + error.message, 'error');
            }
        }

        async function verifyXMR() {
            const paymentId = document.getElementById('xmrId').value;
            const amount = parseFloat(document.getElementById('xmrAmt').value);

            if (!paymentId || !amount) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Verifying Monero payment...', 'warning');

                const response = await fetch(API + '/payments/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currency: 'XMR',
                        proof: paymentId,
                        amount: amount,
                        clientId: wallet
                    })
                });

                const data = await response.json();

                if (data.verified) {
                    showAlert('‚úì Monero payment verified!', 'success');
                    document.getElementById('xmrId').value = '';
                    document.getElementById('xmrAmt').value = '';
                } else {
                    showAlert('‚úó Verification failed', 'error');
                }
            } catch (error) {
                showAlert('Verification failed: ' + error.message, 'error');
            }
        }

        async function depositUSDC() {
            const network = document.getElementById('depositNet').value;
            const amount = parseFloat(document.getElementById('depositAmt').value);
            const address = document.getElementById('depositAddr').value;

            if (!amount || !address) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Processing deposit...', 'warning');

                const response = await fetch(API + '/deposits/usdc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: wallet,
                        to: address,
                        amount: amount,
                        network: network
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('‚úì Deposit initiated!', 'success');
                } else {
                    throw new Error(data.error || 'Deposit failed');
                }
            } catch (error) {
                showAlert('Deposit failed: ' + error.message, 'error');
            }
        }

        async function loadDepositAddress() {
            try {
                const network = document.getElementById('depositNet').value;
                const response = await fetch(API + '/deposit-addresses');
                const data = await response.json();
                
                if (data.depositAddresses?.usdc?.[network]) {
                    document.getElementById('depositAddr').value = data.depositAddresses.usdc[network].address;
                }
            } catch (error) {
                console.error('Failed to load deposit address:', error);
            }
        }

        // ==================== ZK FUNCTIONS ====================
        async function mint() {
            if (!wallet) {
                showAlert('Connect wallet first!', 'error');
                showWalletModal();
                return;
            }

            const amount = parseFloat(document.getElementById('mintAmt').value);
            const currency = document.getElementById('mintCur').value;

            if (!amount) {
                showAlert('Enter amount!', 'error');
                return;
            }

            const secret = '0x' + Array.from({length: 64}, () => 
                Math.floor(Math.random() * 16).toString(16)
            ).join('');
            
            document.getElementById('mintSecret').value = secret;

            try {
                showAlert('Minting commitment...', 'warning');

                const response = await fetch(API + '/zk/mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount, currency, secret, walletAddress: wallet
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('mintRes');
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.classList.remove('hidden');
                    showAlert('‚úì Commitment minted! SAVE YOUR SECRET!', 'success');
                } else {
                    throw new Error(data.error || 'Mint failed');
                }
            } catch (error) {
                showAlert('Mint failed: ' + error.message, 'error');
            }
        }

        async function transfer() {
            const commitment = document.getElementById('transferComm').value;
            const secret = document.getElementById('transferSecret').value;
            const amount = parseFloat(document.getElementById('transferAmt').value);

            if (!commitment || !secret || !amount) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Generating ZK proof...', 'warning');

                const outputSecret = '0x' + Array.from({length: 64}, () => 
                    Math.floor(Math.random() * 16).toString(16)
                ).join('');

                const response = await fetch(API + '/zk/transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inputCommitment: commitment,
                        inputSecret: secret,
                        outputAmount1: amount,
                        outputSecret1: outputSecret,
                        currency: 'USDC',
                        network: 'base'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('transferRes');
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.classList.remove('hidden');
                    showAlert('‚úì Transfer complete!', 'success');
                } else {
                    throw new Error(data.error || 'Transfer failed');
                }
            } catch (error) {
                showAlert('Transfer failed: ' + error.message, 'error');
            }
        }

        async function withdraw() {
            const commitment = document.getElementById('withdrawComm').value;
            const secret = document.getElementById('withdrawSecret').value;
            const amount = parseFloat(document.getElementById('withdrawAmt').value);
            const recipient = document.getElementById('withdrawRecipient').value;

            if (!commitment || !secret || !amount || !recipient) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Processing withdrawal...', 'warning');

                const response = await fetch(API + '/zk/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        commitment, secret, amount, recipient,
                        currency: 'USDC', network: 'base'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('withdrawRes');
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.classList.remove('hidden');
                    showAlert('‚úì Withdrawal initiated!', 'success');
                } else {
                    throw new Error(data.error || 'Withdraw failed');
                }
            } catch (error) {
                showAlert('Withdrawal failed: ' + error.message, 'error');
            }
        }

        // ==================== PRIVACY ROUTING ====================
        async function routePrivacy() {
            const sourceChain = document.getElementById('privSrc').value;
            const amount = parseFloat(document.getElementById('privAmt').value);
            const sourceTxHash = document.getElementById('privTx').value;
            const destChain = document.getElementById('privDest').value;
            const destAddr = document.getElementById('privAddr').value;

            if (!sourceTxHash || !amount || !destAddr) {
                showAlert('Fill all fields!', 'error');
                return;
            }

            try {
                showAlert('Initiating privacy routing...', 'warning');

                const response = await fetch(API + '/payments/privacy-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: wallet,
                        amount, currency: 'USDC',
                        sourceChain, sourceTxHash,
                        destinationChain: destChain,
                        destinationAddress: destAddr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('‚úì Privacy routing initiated!', 'success');
                    checkPrivacyStatus(data.routeId);
                } else {
                    throw new Error(data.error || 'Routing failed');
                }
            } catch (error) {
                showAlert('Failed: ' + error.message, 'error');
            }
        }

        async function checkPrivacyStatus(routeId) {
            const statusDiv = document.getElementById('privStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div style="padding:20px;text-align:center;color:var(--warning);">üîÑ Checking status...</div>';

            const checkStatus = async () => {
                try {
                    const response = await fetch(API + '/payments/privacy-route/' + routeId + '/status');
                    const data = await response.json();

                    if (data.status === 'completed') {
                        statusDiv.innerHTML = `
                            <div style="padding:20px;background:rgba(0,255,136,0.1);border:1px solid var(--success);border-radius:12px;">
                                <strong style="color:var(--success);">‚úì Privacy routing completed!</strong><br>
                                <div style="margin-top:10px;font-size:13px;">
                                    Privacy Score: ${data.privacy.privacyScore}/100<br>
                                    Destination TX: ${data.transactions.destination.txHash}
                                </div>
                            </div>
                        `;
                    } else if (data.status === 'failed') {
                        statusDiv.innerHTML = `
                            <div style="padding:20px;background:rgba(255,68,68,0.1);border:1px solid var(--error);border-radius:12px;">
                                <strong style="color:var(--error);">‚úó Routing failed</strong><br>
                                <div style="margin-top:10px;font-size:13px;">${data.errorMessage || 'Unknown error'}</div>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div style="padding:20px;background:rgba(255,170,0,0.1);border:1px solid var(--warning);border-radius:12px;">
                                <strong style="color:var(--warning);">Status: ${data.status}</strong><br>
                                <div style="margin-top:10px;font-size:13px;">Checking again in 10 seconds...</div>
                            </div>
                        `;
                        setTimeout(checkStatus, 10000);
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<div style="padding:20px;color:var(--error);">Status check failed</div>';
                }
            };

            checkStatus();
        }

        // ==================== SESSIONS ====================
        async function createSession() {
            if (!wallet) {
                showAlert('Connect wallet first!', 'error');
                showWalletModal();
                return;
            }

            const balance = parseFloat(document.getElementById('sessBal').value);
            const commitment = document.getElementById('sessComm').value || '0x0';

            if (!balance || balance < 10) {
                showAlert('Minimum balance is $10!', 'error');
                return;
            }

            try {
                showAlert('Creating session...', 'warning');

                const response = await fetch(API + '/sessions/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: wallet,
                        commitment,
                        initialBalance: balance,
                        currency: 'USDC'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const resultDiv = document.getElementById('sessRes');
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                    resultDiv.classList.remove('hidden');
                    showAlert('‚úì Session created!', 'success');
                } else {
                    throw new Error(data.error || 'Session creation failed');
                }
            } catch (error) {
                showAlert('Failed: ' + error.message, 'error');
            }
        }

        // ==================== ADMIN ====================
        async function adminLogin() {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;

            if (!username || !password) {
                showAlert('Enter credentials!', 'error');
                return;
            }

            try {
                const response = await fetch(API + '/admin/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDash').classList.remove('hidden');
                    showAlert('‚úì Admin logged in!', 'success');
                    loadDashboard();
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (error) {
                showAlert('Login failed: ' + error.message, 'error');
            }
        }

        async function adminSetup() {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;

            if (!username || !password || password.length < 8) {
                showAlert('Password must be 8+ characters!', 'error');
                return;
            }

            try {
                const response = await fetch(API + '/admin/auth/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDash').classList.remove('hidden');
                    showAlert('‚úì Admin account created!', 'success');
                    loadDashboard();
                } else {
                    throw new Error(data.error || 'Setup failed');
                }
            } catch (error) {
                showAlert('Setup failed: ' + error.message, 'error');
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetch(API + '/admin/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('statRev').textContent = '$' + data.overview.totalRevenue;
                    document.getElementById('statPay').textContent = data.overview.totalPayments;
                    document.getElementById('statComm').textContent = data.overview.totalCommitments;
                    document.getElementById('statSess').textContent = data.overview.activeSessions;

                    const paymentsResponse = await fetch(API + '/admin/payments?limit=10', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const paymentsData = await paymentsResponse.json();

                    const table = document.getElementById('payTable');
                    if (paymentsData.payments && paymentsData.payments.length > 0) {
                        table.innerHTML = paymentsData.payments.map(p => `
                            <tr>
                                <td>${new Date(p.createdAt).toLocaleString()}</td>
                                <td>${p.currency}</td>
                                <td>${p.amount}</td>
                                <td>${p.status.toUpperCase()}</td>
                            </tr>
                        `).join('');
                    } else {
                        table.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--text-dim);">No payments yet</td></tr>';
                    }
                }
            } catch (error) {
                showAlert('Dashboard load failed: ' + error.message, 'error');
            }
        }

        function logout() {
            token = null;
            document.getElementById('adminDash').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            showAlert('Logged out', 'success');
        }

        // ==================== HELPERS ====================
        function showAlert(msg, type='success') {
            const alert = document.createElement('div');
            alert.className = 'alert ' + type;
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚ö†';
            alert.innerHTML = `<strong>${icon}</strong> ${msg}`;
            document.body.appendChild(alert);
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        async function updatePrices() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum,zcash,monero,usd-coin,bitcoin&vs_currencies=usd&include_24hr_change=true');
                const data = await response.json();
                
                const ticker = document.getElementById('ticker');
                ticker.innerHTML = `
                    <div class="ticker-item">
                        <span class="ticker-symbol">ETH</span>
                        <span class="price">$${data.ethereum.usd.toLocaleString()}</span>
                        <span class="change ${data.ethereum.usd_24h_change >= 0 ? 'up' : 'down'}">
                            ${data.ethereum.usd_24h_change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.ethereum.usd_24h_change).toFixed(2)}%
                        </span>
                    </div>
                    <div class="ticker-item">
                        <span class="ticker-symbol">BTC</span>
                        <span class="price">$${data.bitcoin.usd.toLocaleString()}</span>
                        <span class="change ${data.bitcoin.usd_24h_change >= 0 ? 'up' : 'down'}">
                            ${data.bitcoin.usd_24h_change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.bitcoin.usd_24h_change).toFixed(2)}%
                        </span>
                    </div>
                    <div class="ticker-item">
                        <span class="ticker-symbol">ZEC</span>
                        <span class="price">$${data.zcash.usd.toLocaleString()}</span>
                        <span class="change ${data.zcash.usd_24h_change >= 0 ? 'up' : 'down'}">
                            ${data.zcash.usd_24h_change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.zcash.usd_24h_change).toFixed(2)}%
                        </span>
                    </div>
                    <div class="ticker-item">
                        <span class="ticker-symbol">XMR</span>
                        <span class="price">$${data.monero.usd.toLocaleString()}</span>
                        <span class="change ${data.monero.usd_24h_change >= 0 ? 'up' : 'down'}">
                            ${data.monero.usd_24h_change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.monero.usd_24h_change).toFixed(2)}%
                        </span>
                    </div>
                `;
            } catch(error) {
                console.error('Price update failed:', error);
            }
        }

        // ==================== TAB NAVIGATION ====================
        document.querySelectorAll('.tab').forEach(t => {
            t.onclick = () => {
                const tabName = t.dataset.tab;
                document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
                document.getElementById(tabName + '-page').classList.add('active');
                
                if (tabName === 'admin' && token) loadDashboard();
            };
        });

        // ==================== INITIALIZATION ====================
        document.getElementById('walletBtn').onclick = () => {
            console.log('üîò Connect Wallet button clicked');
            if (!wallet) {
                showWalletModal();
            } else {
                console.log('Already connected to:', wallet);
            }
        };

        // Update prices on load and every 60 seconds
        updatePrices();
        setInterval(updatePrices, 60000);

        // Wallet detection on page load
        console.log('==================== PAGE INITIALIZATION ====================');
        console.log('üöÄ X402 Protocol Loading...');
        console.log('Document ready state:', document.readyState);
        
        // Function to initialize wallets
        function initializeWallets() {
            console.log('==================== INITIALIZING WALLETS ====================');
            console.log('Checking for window.ethereum...');
            
            if (window.ethereum) {
                console.log('‚úÖ window.ethereum found immediately');
                const wallets = detectWallets();
                if (wallets.length > 0) {
                    console.log(`‚úÖ Found ${wallets.length} wallet(s) on page load`);
                    wallets.forEach((w, idx) => {
                        console.log(`  ${idx}: ${w.name}`);
                    });
                } else {
                    console.log('‚ö†Ô∏è window.ethereum exists but no specific wallets detected');
                }
            } else {
                console.log('‚ö†Ô∏è window.ethereum not found yet, waiting...');
                
                // Wait up to 3 seconds for wallet injection
                let attempts = 0;
                const maxAttempts = 30; // 3 seconds (30 * 100ms)
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    console.log(`Attempt ${attempts}/${maxAttempts}: Checking for window.ethereum...`);
                    
                    if (window.ethereum) {
                        clearInterval(checkInterval);
                        console.log(`‚úÖ window.ethereum found after ${attempts * 100}ms`);
                        const wallets = detectWallets();
                        if (wallets.length > 0) {
                            console.log(`‚úÖ Found ${wallets.length} wallet(s)`);
                        }
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.log('‚ùå window.ethereum not found after 3 seconds');
                        console.log('User needs to install a wallet extension');
                    }
                }, 100);
            }
            
            console.log('==================== WALLET INITIALIZATION COMPLETE ====================');
        }

        // Initialize wallets based on document ready state
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('‚úÖ DOMContentLoaded event fired');
                initializeWallets();
            });
        } else {
            console.log('‚úÖ Document already loaded');
            initializeWallets();
        }

        // Also check on window load (backup)
        window.addEventListener('load', () => {
            console.log('‚úÖ window.load event fired');
            if (!window.detectedWallets) {
                console.log('Running wallet detection again on window.load');
                detectWallets();
            }
        });

        console.log('‚úÖ X402 Protocol Frontend Ready');
        console.log('==================== INITIALIZATION COMPLETE ====================');
    </script>
</body>
</html>
