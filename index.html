<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Money Factory - Privacy Protocol</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a0a2e 50%, #0a0a0f 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .bg-pattern {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.08), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.08), transparent 50%);
            pointer-events: none;
        }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; position: relative; z-index: 1; }
        
        header {
            background: rgba(17, 17, 26, 0.3);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 40;
            padding: 0.75rem 0;
        }
        
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #9333ea, #ec4899);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.5);
            font-size: 1.25rem;
        }
        .logo-text h1 {
            font-size: 1.25rem;
            background: linear-gradient(90deg, #a78bfa, #ec4899, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo-text p { font-size: 0.625rem; color: #9ca3af; }
        
        .btn {
            padding: 0.5rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-primary {
            background: linear-gradient(90deg, #9333ea, #ec4899, #3b82f6);
            color: #fff;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }
        .btn-primary:hover { transform: scale(1.05); }
        .btn-secondary {
            background: rgba(55, 65, 81, 0.5);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-success {
            background: linear-gradient(90deg, #10b981, #059669);
            color: #fff;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .wallet-info { display: flex; align-items: center; gap: 0.75rem; }
        .wallet-badge {
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(16px);
            border-radius: 12px;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .wallet-badge p:first-child { font-size: 0.625rem; color: #9ca3af; }
        .wallet-badge p:last-child { font-family: monospace; font-size: 0.75rem; font-weight: 600; }
        
        .disconnect-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .disconnect-btn:hover { color: #fff; background: rgba(55, 65, 81, 0.5); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .hero-section {
            text-align: center;
            margin: 3rem auto;
            max-width: 900px;
            padding: 2rem;
        }
        
        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(90deg, #a78bfa, #ec4899, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .hero-subtitle {
            font-size: 1.25rem;
            color: #d1d5db;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .hero-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 3rem;
        }
        
        .feature-card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s;
        }
        
        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(147, 51, 234, 0.3);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .feature-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            background: linear-gradient(90deg, #a78bfa, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .feature-description {
            color: #9ca3af;
            line-height: 1.6;
        }
        
        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(147, 51, 234, 0.2); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-label { font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.5rem; font-weight: 500; }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .stat-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(17, 17, 26, 0.3);
            backdrop-filter: blur(20px);
            padding: 0.5rem;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #9ca3af;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .tab:hover { color: #fff; background: rgba(55, 65, 81, 0.4); }
        .tab.active {
            background: linear-gradient(90deg, #9333ea, #ec4899);
            color: #fff;
            transform: scale(1.02);
        }
        
        .card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 768px;
            margin: 0 auto;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .card-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.3s;
        }
        .back-button:hover { color: #fff; }
        
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            color: #d1d5db;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(55, 65, 81, 0.5);
            backdrop-filter: blur(16px);
            color: #fff;
            border-radius: 12px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.2);
        }
        .form-textarea {
            resize: vertical;
            font-family: monospace;
            font-size: 0.75rem;
            min-height: 80px;
        }
        .form-input::placeholder { color: #6b7280; }
        .form-hint {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }
        
        .alert {
            padding: 0.75rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .alert-icon { flex-shrink: 0; font-size: 1.125rem; }
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }
        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fcd34d;
        }
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(16px);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, rgba(17, 17, 26, 0.95), rgba(26, 10, 46, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            max-width: 28rem;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, #a78bfa, #ec4899, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0;
            width: 28px;
            height: 28px;
            transition: color 0.3s;
        }
        .close-btn:hover { color: #fff; }
        
        .wallet-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: linear-gradient(90deg, rgba(55, 65, 81, 0.5), rgba(55, 65, 81, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }
        .wallet-option:hover {
            background: linear-gradient(90deg, rgba(75, 85, 99, 0.5), rgba(75, 85, 99, 0.3));
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .wallet-option-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .wallet-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .wallet-option:hover .wallet-icon { transform: scale(1.1); }
        .wallet-name {
            color: #fff;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .wallet-arrow {
            color: #9ca3af;
            transition: all 0.3s;
        }
        .wallet-option:hover .wallet-arrow {
            color: #fff;
            transform: translateX(4px);
        }
        
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 24rem;
        }
        .notification {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            backdrop-filter: blur(16px);
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            border-color: rgba(16, 185, 129, 0.5);
            color: #fff;
        }
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            border-color: rgba(239, 68, 68, 0.5);
            color: #fff;
        }
        .notification-warning {
            background: rgba(251, 191, 36, 0.9);
            border-color: rgba(251, 191, 36, 0.5);
            color: #fff;
        }
        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            border-color: rgba(59, 130, 246, 0.5);
            color: #fff;
        }
        
        .mixer-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        .mixer-card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s;
        }
        .mixer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(147, 51, 234, 0.2);
        }
        .mixer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .mixer-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .mixer-address {
            font-family: monospace;
            font-size: 0.75rem;
            color: #9ca3af;
            background: rgba(55, 65, 81, 0.5);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: inline-block;
        }
        .mixer-status {
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-active {
            background: linear-gradient(90deg, #10b981, #059669);
            color: #fff;
        }
        .status-inactive {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: #fff;
        }
        .mixer-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .mixer-stat {
            background: rgba(55, 65, 81, 0.3);
            padding: 0.75rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .mixer-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        .mixer-stat-value {
            font-size: 0.875rem;
            font-weight: 600;
        }
        .mixer-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 8px;
        }
        
        .note-display {
            background: rgba(17, 24, 39, 0.5);
            border-radius: 12px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.75rem;
            color: #fff;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        .checkbox-container:hover {
            background: rgba(75, 85, 99, 0.4);
        }
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-label {
            color: #d1d5db;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(16px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .empty-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, rgba(75, 85, 99, 0.3), rgba(55, 65, 81, 0.3));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
        }
        .empty-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #9ca3af;
        }
        .empty-description {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 4rem;
            padding: 1.5rem 0;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .footer-links {
            display: flex;
            gap: 1.5rem;
        }
        .footer-links a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-links a:hover {
            color: #fff;
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 2rem; }
            .hero-subtitle { font-size: 1rem; }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .tab {
                font-size: 0.75rem;
                padding: 0.625rem 0.875rem;
            }
            .card {
                padding: 1.5rem;
            }
            .mixer-stats {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            .wallet-info {
                flex-direction: column;
                align-items: stretch;
            }
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            .cta-buttons {
                flex-direction: column;
            }
            .btn-large {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="navigateToHome()">
                    <div class="logo-icon">üõ°Ô∏è</div>
                    <div class="logo-text">
                        <h1>My Money Factory</h1>
                        <p>Privacy Protocol</p>
                    </div>
                </div>
                
                <div class="wallet-info" id="walletSection">
                    <button class="btn btn-primary" id="connectBtn" onclick="openWalletModal()">
                        üíº Connect Wallet
                    </button>
                    
                    <div class="hidden" id="connectedSection">
                        <div class="wallet-badge">
                            <p>Connected</p>
                            <p id="accountDisplay"></p>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectWallet()" title="Disconnect">
                            ‚úñÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- HOME PAGE -->
    <div id="homePage" class="page active">
        <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
            <div class="hero-section">
                <h2 class="hero-title">
                    Your Personal Privacy Vault on Ethereum
                </h2>
                <p class="hero-subtitle">
                    Deploy your own mixer contract. Pay once, own forever. Complete anonymity with zero-knowledge proofs.
                </p>
                
                <div class="cta-buttons">
                    <button class="btn btn-primary btn-large" onclick="navigateToApp()">
                        üöÄ Launch App
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="scrollToFeatures()">
                        üìñ Learn More
                    </button>
                </div>
            </div>
            
            <div class="hero-features" id="featuresSection">
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <div class="feature-title">Own Your Vault</div>
                    <div class="feature-description">
                        Deploy a personal mixer contract that you control. It's yours forever, no recurring fees.
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üé≠</div>
                    <div class="feature-title">Total Privacy</div>
                    <div class="feature-description">
                        Zero-knowledge proofs ensure your deposits and withdrawals are completely unlinkable.
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üíé</div>
                    <div class="feature-title">One-Time Fee</div>
                    <div class="feature-description">
                        Pay 1 ETH deployment fee once, then use your vault unlimited times with no additional costs.
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <div class="feature-title">Fast & Secure</div>
                    <div class="feature-description">
                        Built on Ethereum with battle-tested cryptography. Your funds are always safe.
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üåê</div>
                    <div class="feature-title">Shared Anonymity</div>
                    <div class="feature-description">
                        All mixers share one Merkle tree for maximum anonymity set and privacy protection.
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">üîê</div>
                    <div class="feature-title">Non-Custodial</div>
                    <div class="feature-description">
                        You control your funds at all times. Only you have the withdrawal keys.
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 4rem;">
                <h3 style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem; background: linear-gradient(90deg, #a78bfa, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    How It Works
                </h3>
                <div style="max-width: 800px; margin: 0 auto; display: grid; gap: 2rem; margin-top: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem; text-align: left;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #9333ea, #ec4899); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700;">1</div>
                        <div>
                            <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">Deploy Your Vault</div>
                            <div style="color: #9ca3af;">Pay 1 ETH to deploy your personal mixer contract to Ethereum.</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1.5rem; text-align: left;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700;">2</div>
                        <div>
                            <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">Make Deposits</div>
                            <div style="color: #9ca3af;">Deposit funds and receive a secret withdrawal note. Save it securely!</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1.5rem; text-align: left;">
                        <div style="flex-shrink: 0; width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700;">3</div>
                        <div>
                            <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">Withdraw Anonymously</div>
                            <div style="color: #9ca3af;">Use your note to withdraw to any address. The link is cryptographically broken.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- APP PAGE -->
    <div id="appPage" class="page">
        <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
            <div class="back-button" onclick="navigateToHome()">
                ‚Üê Back to Home
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Mixers</div>
                            <div class="stat-value" id="totalMixers">0</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #9333ea, #ec4899);">üë•</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Fees Collected</div>
                            <div class="stat-value" id="totalFees">0 ETH</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">üí∞</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Global Nullifiers</div>
                            <div class="stat-value" id="totalNullifiers">0</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üîí</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Your Balance</div>
                            <div class="stat-value" id="userBalance">0 ETH</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">‚ú®</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('deploy')">
                    ‚ö° Deploy Mixer
                </button>
                <button class="tab" onclick="switchTab('deposit')">
                    üõ°Ô∏è Deposit
                </button>
                <button class="tab" onclick="switchTab('withdraw')">
                    üíµ Withdraw
                </button>
                <button class="tab" onclick="switchTab('mixers')">
                    üîê My Mixers
                </button>
            </div>
            
            <!-- Deploy Tab -->
            <div id="deployTab" class="card">
                <h3 class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, #9333ea, #ec4899);">‚ö°</div>
                    Deploy Your Privacy Mixer
                </h3>
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">üí°</span>
                    <div>
                        <strong>What You Get:</strong>
                        <p style="margin-top: 0.5rem;">Pay 1 ETH once to deploy your personal mixer contract. You get your own liquidity pool with isolated balances. All mixers share the same verifier, Merkle tree, and nullifier registry for maximum privacy.</p>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <span class="alert-icon">üí∞</span>
                    <div>
                        <strong>Deployment Fee: 1 ETH</strong>
                        <p style="margin-top: 0.5rem;">One-time payment to the factory admin. After deployment, you own your mixer forever with no recurring fees (only gas costs).</p>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="deployMixer()" id="deployBtn">
                    ‚ú® Deploy My Mixer (1 ETH)
                </button>
            </div>
            
            <!-- Deposit Tab -->
            <div id="depositTab" class="card hidden">
                <h3 class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">üõ°Ô∏è</div>
                    Deposit Into Your Mixer
                </h3>
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">üîê</span>
                    <div>
                        <strong>How Deposits Work:</strong>
                        <p style="margin-top: 0.5rem;">Your commitment goes to the SHARED Merkle tree (bigger anonymity set). You'll get a secret note. The nullifier is checked GLOBALLY across all mixers to prevent double-spending.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Your Mixer</label>
                    <select id="depositMixer" class="form-select">
                        <option value="">Choose your mixer...</option>
                    </select>
                </div>
                
                <div id="noteDisplay" class="hidden">
                    <div class="alert alert-success">
                        <span class="alert-icon">üìÑ</span>
                        <div style="flex: 1;">
                            <strong>Your Withdrawal Note</strong>
                            <p style="margin-top: 0.25rem;">This note is required to withdraw your funds. Save it securely!</p>
                            <div class="note-display" id="noteString"></div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                                <button class="btn btn-secondary btn-small" onclick="copyNote()">üìã Copy</button>
                                <button class="btn btn-secondary btn-small" onclick="downloadNote()">üíæ Download</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div>
                        <strong>CRITICAL: Save Your Note</strong>
                        <p style="margin-top: 0.25rem;">Your note contains the secret and nullifier needed to withdraw. Without it, your funds are PERMANENTLY LOST. Save it in multiple secure locations.</p>
                    </div>
                </div>
                
                <button class="btn btn-success" style="width: 100%;" onclick="makeDeposit()" id="depositBtn">
                    üõ°Ô∏è Make Private Deposit
                </button>
            </div>
            
            <!-- Withdraw Tab -->
            <div id="withdrawTab" class="card hidden">
                <h3 class="card-title">
                    <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">üíµ</div>
                    Withdraw Funds
                </h3>
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">üîí</span>
                    <div>
                        <strong>Global Nullifier Check:</strong>
                        <p style="margin-top: 0.5rem;">Your nullifier is checked against the SHARED nullifier registry. Once spent, it cannot be used again across ANY mixer in the system.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Withdrawal Note</label>
                    <textarea id="withdrawNote" class="form-textarea" rows="3" placeholder="Paste your withdrawal note here (mymoney-...)"></textarea>
                    <div style="margin-top: 0.5rem;">
                        <label class="btn btn-secondary btn-small" style="cursor: pointer;">
                            üì§ Upload Note File
                            <input type="file" accept=".txt" onchange="loadNoteFile(event)" style="display: none;">
                        </label>
                    </div>
                </div>
                
                <div id="parsedNoteDisplay" class="hidden">
                    <div class="alert alert-info">
                        <span class="alert-icon">‚ú®</span>
                        <div style="flex: 1;">
                            <strong>Parsed Note Details</strong>
                            <div style="margin-top: 0.5rem; font-size: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="color: #9ca3af;">Amount:</span>
                                    <strong id="parsedAmount"></strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="color: #9ca3af;">Mixer:</span>
                                    <span style="font-family: monospace;" id="parsedMixer"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #9ca3af;">Chain ID:</span>
                                    <span id="parsedChain"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Address</label>
                    <input type="text" id="recipient" class="form-input" placeholder="0x... (where to send the withdrawn funds)" style="font-family: monospace;">
                </div>
                
                <div class="checkbox-container" onclick="toggleRelayer()">
                    <input type="checkbox" id="useRelayer" class="checkbox">
                    <label class="checkbox-label" for="useRelayer">
                        Use Relayer (Maximum Privacy - hides recipient link)
                    </label>
                </div>
                
                <div id="relayerFeeSection" class="form-group hidden">
                    <label class="form-label">Relayer Fee (ETH)</label>
                    <input type="number" id="relayerFee" class="form-input" value="0.01" step="0.001" min="0.001">
                </div>
                
                <div id="proofGenerating" class="alert alert-info hidden">
                    <span class="alert-icon"><div class="loading-spinner"></div></span>
                    <div>
                        <strong>Generating zero-knowledge proof...</strong> Please wait.
                    </div>
                </div>
                
                <div class="alert alert-error">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div>
                        <strong>Warning</strong>
                        <p style="margin-top: 0.25rem;">Once withdrawn, this note cannot be used again (nullifier marked globally). Verify the recipient address is correct.</p>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb);" onclick="withdrawFunds()" id="withdrawBtn">
                    üíµ Withdraw Funds Anonymously
                </button>
            </div>
            
            <!-- My Mixers Tab -->
            <div id="mixersTab" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="card-title" style="margin-bottom: 0;">
                        <div class="card-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">üîê</div>
                        My Mixers
                    </h3>
                    <button class="btn btn-secondary" onclick="refreshMixers()" id="refreshBtn">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">üìä</span>
                    <div>
                        <strong>Your Personal Mixers:</strong>
                        <p style="margin-top: 0.5rem;">Each mixer you deploy is YOUR contract. You control the liquidity pool. All mixers share the same verifier and Merkle tree for stronger anonymity.</p>
                    </div>
                </div>
                
                <div id="mixersList">
                    <div class="empty-state">
                        <div class="empty-icon">üîê</div>
                        <div class="empty-title">No mixers deployed yet</div>
                        <div class="empty-description">Deploy your first privacy mixer to get started. Pay 1 ETH once, own forever!</div>
                    </div>
                </div>
                
                <div id="savedNotes" class="hidden" style="margin-top: 2rem;">
                    <h4 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        üìÑ Saved Notes (<span id="notesCount">0</span>)
                    </h4>
                    <div class="alert alert-success">
                        <span class="alert-icon">‚úÖ</span>
                        <div>
                            You have <strong id="notesCountText">0</strong> withdrawal note(s) saved locally. Keep these secure!
                            <div style="margin-top: 0.25rem; font-size: 0.75rem;">
                                Notes are stored in your browser's local storage only.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div>¬© 2025 My Money Factory. Privacy-preserving protocol.</div>
                <div class="footer-links">
                    <a href="#" onclick="return false;">Documentation</a>
                    <a href="#" onclick="return false;">GitHub</a>
                    <a href="#" onclick="return false;">Support</a>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Wallet Connect Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Connect Wallet</h3>
                <button class="close-btn" onclick="closeWalletModal()">√ó</button>
            </div>
            <p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 1.5rem;">Choose your preferred wallet provider</p>
            
            <button class="wallet-option" onclick="connectWallet('metamask')" id="metamaskBtn">
                <div class="wallet-option-left">
                    <span class="wallet-icon">ü¶ä</span>
                    <span class="wallet-name">MetaMask</span>
                </div>
                <span class="wallet-arrow">‚Üí</span>
            </button>
            
            <button class="wallet-option" onclick="connectWallet('walletconnect')" id="walletconnectBtn">
                <div class="wallet-option-left">
                    <span class="wallet-icon">üîó</span>
                    <span class="wallet-name">WalletConnect</span>
                </div>
                <span class="wallet-arrow">‚Üí</span>
            </button>
            
            <button class="wallet-option" onclick="connectWallet('coinbase')" id="coinbaseBtn">
                <div class="wallet-option-left">
                    <span class="wallet-icon">üî∂</span>
                    <span class="wallet-name">Coinbase Wallet</span>
                </div>
                <span class="wallet-arrow">‚Üí</span>
            </button>
            
            <button class="wallet-option" onclick="connectWallet('trust')" id="trustBtn">
                <div class="wallet-option-left">
                    <span class="wallet-icon">üíé</span>
                    <span class="wallet-name">Trust Wallet</span>
                </div>
                <span class="wallet-arrow">‚Üí</span>
            </button>
        </div>
    </div>
    
    <!-- Notifications Container -->
    <div class="notification-container" id="notifications"></div>
    
    <script>
        // CONTRACT ADDRESSES - UPDATE THESE AFTER DEPLOYMENT
        const FACTORY_ADDRESS = '0x0000000000000000000000000000000000000000'; // PrivacyMixerFactory
        const VERIFIER_ADDRESS = '0x0000000000000000000000000000000000000000'; // MixerVerifier
        const MERKLE_TREE_ADDRESS = '0x0000000000000000000000000000000000000000'; // MerkleTree
        const NULLIFIER_REGISTRY_ADDRESS = '0x0000000000000000000000000000000000000000'; // SharedNullifierRegistry
        
        const FACTORY_ABI = [
            "function deployMyMixer() external payable returns (address)",
            "function userMixerAddress(address) external view returns (address)",
            "function getUserMixerInfo(address) external view returns (bool, address, uint256, uint256)",
            "function getAdminStats() external view returns (uint256, uint256, uint256, uint256, address)",
            "function DEPLOYMENT_FEE() external view returns (uint256)",
            "event MixerDeployedForUser(address indexed user, address indexed mixerAddress, uint256 deploymentFee, uint256 timestamp)"
        ];
        
        const MIXER_ABI = [
            "function depositToMyMixer(bytes32, address, uint256) external payable",
            "function withdrawFromMyMixer(uint[2], uint[2][2], uint[2], uint[6], bytes32, address, address, uint256, uint256) external payable",
            "function getMyMixerStats() external view returns (address, uint256, uint256, uint256, address, address, address)",
            "function getMyPoolBalance(address) external view returns (uint256)",
            "function doISupportDenomination(uint256) external view returns (bool)",
            "function DENOM_0_1_ETH() external view returns (uint256)",
            "function DENOM_1_ETH() external view returns (uint256)",
            "function DENOM_10_ETH() external view returns (uint256)",
            "function DENOM_100_ETH() external view returns (uint256)",
            "event MyDeposit(bytes32 indexed commitment, address indexed token, uint256 amount, uint256 timestamp)",
            "event MyWithdrawal(bytes32 indexed nullifierHash, address indexed recipient, address token, uint256 amount, uint256 fee)"
        ];
        
        const NULLIFIER_REGISTRY_ABI = [
            "function isSpent(bytes32) external view returns (bool)",
            "function totalNullifiersSpent() external view returns (uint256)",
            "function getNullifierInfo(bytes32) external view returns (bool, address, uint256)"
        ];
        
        const MERKLE_TREE_ABI = [
            "function addCommitment(bytes32) external returns (uint32)",
            "function getRoot() external view returns (bytes32)",
            "function isKnownRoot(bytes32) external view returns (bool)",
            "function nextIndex() external view returns (uint32)"
        ];
        
        // Global state
        let provider = null;
        let signer = null;
        let account = '';
        let chainId = null;
        let mixers = [];
        let notes = [];
        let currentDeposit = null;
        let parsedNote = null;
        
        // Navigation functions
        function navigateToHome() {
            document.getElementById('homePage').classList.add('active');
            document.getElementById('appPage').classList.remove('active');
            window.scrollTo(0, 0);
        }
        
        function navigateToApp() {
            document.getElementById('homePage').classList.remove('active');
            document.getElementById('appPage').classList.add('active');
            window.scrollTo(0, 0);
            if (provider) {
                loadUserData();
                loadFactoryStats();
            }
        }
        
        function scrollToFeatures() {
            document.getElementById('featuresSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Initialize app
        window.addEventListener('load', () => {
            loadStoredNotes();
            checkExistingConnection();
        });
        
        // Check for existing wallet connection
        async function checkExistingConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await initializeProvider();
                    }
                } catch (error) {
                    console.error('Error checking connection:', error);
                }
            }
        }
        
        // Initialize provider
        async function initializeProvider() {
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();
                
                const network = await provider.getNetwork();
                chainId = network.chainId;
                
                updateUI();
                await loadUserData();
                await loadFactoryStats();
                
                // Setup event listeners
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (error) {
                console.error('Error initializing provider:', error);
                showNotification('Failed to initialize provider', 'error');
            }
        }
        
        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                account = accounts[0];
                updateUI();
                await loadUserData();
            }
        }
        
        // Wallet connection functions
        function openWalletModal() {
            document.getElementById('walletModal').classList.add('active');
        }
        
        function closeWalletModal() {
            document.getElementById('walletModal').classList.remove('active');
        }
        
        async function connectWallet(providerType) {
            try {
                if (providerType === 'metamask') {
                    if (typeof window.ethereum === 'undefined') {
                        showNotification('MetaMask is not installed', 'error');
                        window.open('https://metamask.io/download.html', '_blank');
                        return;
                    }
                    
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    await initializeProvider();
                    showNotification('MetaMask connected successfully', 'success');
                    closeWalletModal();
                    
                } else {
                    showNotification(`${providerType} integration coming soon`, 'info');
                }
            } catch (error) {
                console.error('Connection error:', error);
                showNotification(`Failed to connect: ${error.message}`, 'error');
            }
        }
        
        function disconnectWallet() {
            provider = null;
            signer = null;
            account = '';
            chainId = null;
            mixers = [];
            updateUI();
            showNotification('Wallet disconnected', 'info');
        }
        
        // Update UI based on connection status
        function updateUI() {
            if (account) {
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('connectedSection').classList.remove('hidden');
                document.getElementById('accountDisplay').textContent = 
                    account.slice(0, 6) + '...' + account.slice(-4);
                
                updateBalance();
            } else {
                document.getElementById('connectBtn').classList.remove('hidden');
                document.getElementById('connectedSection').classList.add('hidden');
                document.getElementById('userBalance').textContent = '0 ETH';
            }
            
            updateMixerSelect();
        }
        
        async function updateBalance() {
            if (!provider || !account) return;
            try {
                const balance = await provider.getBalance(account);
                const formatted = ethers.utils.formatEther(balance);
                document.getElementById('userBalance').textContent = 
                    parseFloat(formatted).toFixed(4) + ' ETH';
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }
        
        // Load user data
        async function loadUserData() {
            if (!provider || !account) return;
            
            try {
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                const mixerAddress = await factory.userMixerAddress(account);
                
                if (mixerAddress !== ethers.constants.AddressZero) {
                    const mixer = new ethers.Contract(mixerAddress, MIXER_ABI, provider);
                    const stats = await mixer.getMyMixerStats();
                    
                    mixers = [{
                        address: mixerAddress,
                        owner: stats[0],
                        totalDeposits: stats[1].toString(),
                        totalWithdrawals: stats[2].toString(),
                        totalVolume: ethers.utils.formatEther(stats[3]),
                        verifier: stats[4],
                        merkleTree: stats[5],
                        nullifierRegistry: stats[6]
                    }];
                } else {
                    mixers = [];
                }
                
                updateMixersList();
                updateMixerSelect();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Failed to load mixers', 'error');
            }
        }
        
        // Load factory stats
        async function loadFactoryStats() {
            if (!provider) return;
            
            try {
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                const stats = await factory.getAdminStats();
                
                document.getElementById('totalMixers').textContent = stats[3].toString();
                document.getElementById('totalFees').textContent = 
                    parseFloat(ethers.utils.formatEther(stats[0])).toFixed(2) + ' ETH';
                
                // Get nullifier registry stats
                const nullifierRegistry = new ethers.Contract(NULLIFIER_REGISTRY_ADDRESS, NULLIFIER_REGISTRY_ABI, provider);
                const totalNullifiers = await nullifierRegistry.totalNullifiersSpent();
                document.getElementById('totalNullifiers').textContent = totalNullifiers.toString();
                    
            } catch (error) {
                console.error('Error loading factory stats:', error);
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('deployTab').classList.add('hidden');
            document.getElementById('depositTab').classList.add('hidden');
            document.getElementById('withdrawTab').classList.add('hidden');
            document.getElementById('mixersTab').classList.add('hidden');
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            if (tabName === 'deposit') {
                currentDeposit = generateDeposit();
                document.getElementById('noteDisplay').classList.add('hidden');
            }
        }
        
        // Deploy mixer
        async function deployMixer() {
            if (!signer) {
                showNotification('Please connect your wallet first', 'warning');
                openWalletModal();
                return;
            }
            
            const deployBtn = document.getElementById('deployBtn');
            deployBtn.disabled = true;
            deployBtn.innerHTML = '<div class="loading-spinner"></div> Deploying Your Mixer...';
            
            try {
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
                
                // Check if user already has a mixer
                const existingMixer = await factory.userMixerAddress(account);
                if (existingMixer !== ethers.constants.AddressZero) {
                    showNotification('You already have a mixer deployed!', 'warning');
                    deployBtn.disabled = false;
                    deployBtn.innerHTML = '‚ú® Deploy My Mixer (1 ETH)';
                    return;
                }
                
                const fee = await factory.DEPLOYMENT_FEE();
                showNotification(`Deployment fee: ${ethers.utils.formatEther(fee)} ETH. Confirm transaction...`, 'info');
                
                const tx = await factory.deployMyMixer({ 
                    value: fee,
                    gasLimit: 5000000
                });
                
                showNotification('üöÄ Transaction sent! Deploying your mixer...', 'info');
                const receipt = await tx.wait();
                
                const event = receipt.events?.find(e => e.event === 'MixerDeployedForUser');
                if (event) {
                    showNotification(`üéâ Success! Your mixer is live at ${event.args.mixerAddress.slice(0, 10)}...`, 'success');
                    await loadUserData();
                    await loadFactoryStats();
                    switchTab('mixers');
                }
                
            } catch (error) {
                console.error('Deployment failed:', error);
                if (error.code === 4001) {
                    showNotification('Transaction cancelled by user', 'warning');
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    showNotification('Insufficient funds to pay deployment fee', 'error');
                } else {
                    showNotification(`Deployment failed: ${error.message}`, 'error');
                }
            } finally {
                deployBtn.disabled = false;
                deployBtn.innerHTML = '‚ú® Deploy My Mixer (1 ETH)';
            }
        }
        
        // Make deposit
        async function makeDeposit() {
            if (!signer) {
                showNotification('Please connect your wallet', 'warning');
                openWalletModal();
                return;
            }
            
            const selectedMixer = document.getElementById('depositMixer').value;
            if (!selectedMixer) {
                showNotification('Please select a mixer', 'warning');
                return;
            }
            
            if (!currentDeposit) {
                currentDeposit = generateDeposit();
            }
            
            const depositBtn = document.getElementById('depositBtn');
            depositBtn.disabled = true;
            depositBtn.innerHTML = '<div class="loading-spinner"></div> Processing...';
            
            try {
                const mixer = new ethers.Contract(selectedMixer, MIXER_ABI, signer);
                
                // Get denomination (default to 0.1 ETH for now)
                const denomination = await mixer.DENOM_0_1_ETH();
                
                // Generate commitment
                const commitment = pedersenHash(
                    ethers.utils.solidityKeccak256(
                        ['uint256', 'uint256'], 
                        [currentDeposit.secret, currentDeposit.nullifier]
                    )
                );
                
                showNotification('Submitting deposit transaction...', 'info');
                
                const tx = await mixer.depositToMyMixer(
                    commitment,
                    ethers.constants.AddressZero, // ETH
                    denomination,
                    { value: denomination, gasLimit: 1000000 }
                );
                
                showNotification('Deposit transaction sent. Waiting for confirmation...', 'info');
                const receipt = await tx.wait();
                
                const event = receipt.events?.find(e => e.event === 'MyDeposit');
                
                if (event) {
                    const note = createNote({
                        secret: currentDeposit.secret,
                        nullifier: currentDeposit.nullifier,
                        mixerAddress: selectedMixer,
                        denomination: ethers.utils.formatEther(denomination)
                    });
                    
                    document.getElementById('noteString').textContent = note;
                    document.getElementById('noteDisplay').classList.remove('hidden');
                    
                    const noteData = {
                        noteString: note,
                        mixerAddress: selectedMixer,
                        denomination: ethers.utils.formatEther(denomination),
                        timestamp: Date.now(),
                        commitment: commitment
                    };
                    
                    saveNote(noteData);
                    showNotification('‚úÖ Deposit successful! BACKUP YOUR NOTE NOW!', 'success');
                    
                    await loadUserData();
                    await loadFactoryStats();
                }
                
            } catch (error) {
                console.error('Deposit failed:', error);
                showNotification(`Deposit failed: ${error.message}`, 'error');
            } finally {
                depositBtn.disabled = false;
                depositBtn.innerHTML = 'üõ°Ô∏è Make Private Deposit';
            }
        }
        
        // Withdraw funds
        async function withdrawFunds() {
            if (!signer) {
                showNotification('Please connect your wallet', 'warning');
                openWalletModal();
                return;
            }
            
            if (!parsedNote) {
                showNotification('Please provide a valid note', 'warning');
                return;
            }
            
            const recipient = document.getElementById('recipient').value;
            if (!recipient || !ethers.utils.isAddress(recipient)) {
                showNotification('Please provide a valid recipient address', 'warning');
                return;
            }
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            withdrawBtn.disabled = true;
            withdrawBtn.innerHTML = '<div class="loading-spinner"></div> Processing...';
            
            document.getElementById('proofGenerating').classList.remove('hidden');
            
            try {
                // Check if nullifier already spent in SHARED registry
                const nullifierRegistry = new ethers.Contract(NULLIFIER_REGISTRY_ADDRESS, NULLIFIER_REGISTRY_ABI, provider);
                
                const nullifierHash = pedersenHash(
                    ethers.utils.solidityKeccak256(['uint256'], [parsedNote.nullifier])
                );
                
                const isSpent = await nullifierRegistry.isSpent(nullifierHash);
                if (isSpent) {
                    const info = await nullifierRegistry.getNullifierInfo(nullifierHash);
                    throw new Error(`This note has already been spent! Used by mixer: ${info[1]}`);
                }
                
                showNotification('Building Merkle proof...', 'info');
                
                // Build Merkle tree from SHARED tree contract
                const merkleTree = new ethers.Contract(MERKLE_TREE_ADDRESS, MERKLE_TREE_ABI, provider);
                const root = await merkleTree.getRoot();
                
                // Generate commitment
                const commitment = pedersenHash(
                    ethers.utils.solidityKeccak256(
                        ['uint256', 'uint256'], 
                        [parsedNote.secret, parsedNote.nullifier]
                    )
                );
                
                showNotification('Generating zero-knowledge proof... This may take a minute.', 'info');
                
                const useRelayer = document.getElementById('useRelayer').checked;
                const relayerFee = useRelayer ? document.getElementById('relayerFee').value : '0';
                
                // Generate proof (simplified - in production use snarkjs)
                const proof = await generateWithdrawProof({
                    secret: parsedNote.secret,
                    nullifier: parsedNote.nullifier,
                    recipient,
                    relayer: useRelayer ? "0x0000000000000000000000000000000000000001" : ethers.constants.AddressZero,
                    fee: useRelayer ? ethers.utils.parseEther(relayerFee) : 0,
                    refund: 0,
                    nullifierHash,
                    root
                });
                
                document.getElementById('proofGenerating').classList.add('hidden');
                showNotification('Proof generated! Submitting withdrawal...', 'info');
                
                const mixer = new ethers.Contract(parsedNote.mixerAddress, MIXER_ABI, signer);
                
                // Call withdrawFromMyMixer
                const tx = await mixer.withdrawFromMyMixer(
                    proof.a,
                    proof.b,
                    proof.c,
                    [
                        ethers.utils.parseEther(parsedNote.denomination),
                        0, // token (ETH = 0)
                        root,
                        nullifierHash,
                        recipient,
                        useRelayer ? "0x0000000000000000000000000000000000000001" : ethers.constants.AddressZero
                    ],
                    nullifierHash,
                    recipient,
                    useRelayer ? "0x0000000000000000000000000000000000000001" : ethers.constants.AddressZero,
                    useRelayer ? ethers.utils.parseEther(relayerFee) : 0,
                    0,
                    { gasLimit: 2000000 }
                );
                
                showNotification('Withdrawal transaction sent. Waiting for confirmation...', 'info');
                const receipt = await tx.wait();
                
                if (receipt.status === 1) {
                    showNotification('‚úÖ Withdrawal successful! Funds sent anonymously.', 'success');
                    deleteNote(document.getElementById('withdrawNote').value);
                    document.getElementById('withdrawNote').value = '';
                    document.getElementById('parsedNoteDisplay').classList.add('hidden');
                    parsedNote = null;
                    await loadUserData();
                    await loadFactoryStats();
                }
                
            } catch (error) {
                console.error('Withdrawal failed:', error);
                showNotification(`Withdrawal failed: ${error.message}`, 'error');
            } finally {
                document.getElementById('proofGenerating').classList.add('hidden');
                withdrawBtn.disabled = false;
                withdrawBtn.innerHTML = 'üíµ Withdraw Funds Anonymously';
            }
        }
        
        // Helper functions
        function generateRandomBigInt() {
            const bytes = new Uint8Array(31);
            crypto.getRandomValues(bytes);
            return '0x' + Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function generateDeposit() {
            return {
                secret: generateRandomBigInt(),
                nullifier: generateRandomBigInt()
            };
        }
        
        function pedersenHash(data) {
            // Simplified - in production use actual Poseidon hash
            return data;
        }
        
        function createNote({ secret, nullifier, mixerAddress, denomination }) {
            return `mymoney-${denomination}-${chainId}-${mixerAddress}-${secret}-${nullifier}`;
        }
        
        function parseNote(noteString) {
            const parts = noteString.trim().split('-');
            if (parts[0] !== 'mymoney' || parts.length !== 6) {
                throw new Error('Invalid note format');
            }
            return {
                protocol: parts[0],
                denomination: parts[1],
                chainId: parts[2],
                mixerAddress: parts[3],
                secret: parts[4],
                nullifier: parts[5]
            };
        }
        
        async function generateWithdrawProof(params) {
            // Simulate proof generation - in production use snarkjs with your circuit
            await new Promise(resolve => setTimeout(resolve, 2000));
            return {
                a: ["0", "0"],
                b: [["0", "0"], ["0", "0"]],
                c: ["0", "0"]
            };
        }
        
        // Note management
        function loadStoredNotes() {
            try {
                const stored = localStorage.getItem('myMoney_notes');
                if (stored) {
                    notes = JSON.parse(stored);
                    updateNotesDisplay();
                }
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        function saveNote(note) {
            try {
                notes.push(note);
                localStorage.setItem('myMoney_notes', JSON.stringify(notes));
                updateNotesDisplay();
            } catch (error) {
                console.error('Error saving note:', error);
            }
        }
        
        function deleteNote(noteString) {
            try {
                notes = notes.filter(note => note.noteString !== noteString);
                localStorage.setItem('myMoney_notes', JSON.stringify(notes));
                updateNotesDisplay();
            } catch (error) {
                console.error('Error deleting note:', error);
            }
        }
        
        function updateNotesDisplay() {
            if (notes.length > 0) {
                document.getElementById('savedNotes').classList.remove('hidden');
                document.getElementById('notesCount').textContent = notes.length;
                document.getElementById('notesCountText').textContent = notes.length;
            } else {
                document.getElementById('savedNotes').classList.add('hidden');
            }
        }
        
        // UI update functions
        function updateMixersList() {
            const mixersList = document.getElementById('mixersList');
            
            if (mixers.length === 0) {
                mixersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîê</div>
                        <div class="empty-title">No mixers deployed yet</div>
                        <div class="empty-description">Deploy your first privacy mixer to get started. Pay 1 ETH once, own forever!</div>
                    </div>
                `;
                return;
            }
            
            mixersList.innerHTML = `
                <div class="mixer-grid">
                    ${mixers.map(mixer => `
                        <div class="mixer-card">
                            <div class="mixer-header">
                                <div>
                                    <div class="mixer-title">üîê Your Privacy Mixer</div>
                                    <div class="mixer-address">${mixer.address}</div>
                                </div>
                                <div class="mixer-status status-active">
                                    ‚óè Active
                                </div>
                            </div>
                            <div class="mixer-stats">
                                <div class="mixer-stat">
                                    <div class="mixer-stat-label">Total Deposits</div>
                                    <div class="mixer-stat-value">${mixer.totalDeposits}</div>
                                </div>
                                <div class="mixer-stat">
                                    <div class="mixer-stat-label">Total Withdrawals</div>
                                    <div class="mixer-stat-value">${mixer.totalWithdrawals}</div>
                                </div>
                                <div class="mixer-stat">
                                    <div class="mixer-stat-label">Total Volume</div>
                                    <div class="mixer-stat-value">${parseFloat(mixer.totalVolume).toFixed(4)} ETH</div>
                                </div>
                                <div class="mixer-stat">
                                    <div class="mixer-stat-label">Shared Infrastructure</div>
                                    <div class="mixer-stat-value">‚úì Enabled</div>
                                </div>
                            </div>
                            <div class="alert alert-info" style="margin-top: 0.75rem; font-size: 0.75rem;">
                                <span class="alert-icon">üîí</span>
                                <div>
                                    Uses shared verifier, Merkle tree, and nullifier registry for maximum privacy
                                </div>
                            </div>
                            <div class="mixer-actions" style="margin-top: 0.75rem;">
                                <button class="btn btn-secondary btn-small" onclick="copyAddress('${mixer.address}')">
                                    üìã Copy Address
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="viewOnExplorer('${mixer.address}')">
                                    üîó View on Etherscan
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function updateMixerSelect() {
            const select = document.getElementById('depositMixer');
            
            select.innerHTML = '<option value="">Choose your mixer...</option>' +
                mixers.map(mixer => 
                    `<option value="${mixer.address}">üîê Your Mixer - ${mixer.address.slice(0, 10)}...</option>`
                ).join('');
        }
        
        async function refreshMixers() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<div class="loading-spinner"></div> Refreshing...';
            
            await loadUserData();
            await loadFactoryStats();
            
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = 'üîÑ Refresh';
            showNotification('Data refreshed', 'success');
        }
        
        // Withdraw note handling
        document.getElementById('withdrawNote').addEventListener('input', (e) => {
            const noteInput = e.target.value.trim();
            if (noteInput) {
                try {
                    parsedNote = parseNote(noteInput);
                    document.getElementById('parsedAmount').textContent = parsedNote.denomination + ' ETH';
                    document.getElementById('parsedMixer').textContent = parsedNote.mixerAddress.slice(0, 16) + '...';
                    document.getElementById('parsedChain').textContent = parsedNote.chainId;
                    document.getElementById('parsedNoteDisplay').classList.remove('hidden');
                    showNotification('Note parsed successfully', 'success');
                } catch (error) {
                    parsedNote = null;
                    document.getElementById('parsedNoteDisplay').classList.add('hidden');
                }
            } else {
                parsedNote = null;
                document.getElementById('parsedNoteDisplay').classList.add('hidden');
            }
        });
        
        function loadNoteFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    document.getElementById('withdrawNote').value = content.trim();
                    document.getElementById('withdrawNote').dispatchEvent(new Event('input'));
                };
                reader.readAsText(file);
            }
        }
        
        function toggleRelayer() {
            const checkbox = document.getElementById('useRelayer');
            checkbox.checked = !checkbox.checked;
            const feeSection = document.getElementById('relayerFeeSection');
            if (checkbox.checked) {
                feeSection.classList.remove('hidden');
            } else {
                feeSection.classList.add('hidden');
            }
        }
        
        // Copy and download functions
        function copyNote() {
            const note = document.getElementById('noteString').textContent;
            navigator.clipboard.writeText(note);
            showNotification('Note copied to clipboard', 'success');
        }
        
        function downloadNote() {
            const note = document.getElementById('noteString').textContent;
            const element = document.createElement('a');
            const file = new Blob([note], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `mymoney-note-${Date.now()}.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            showNotification('Note downloaded successfully', 'success');
        }
        
        function copyAddress(address) {
            navigator.clipboard.writeText(address);
            showNotification('Address copied to clipboard', 'success');
        }
        
        function viewOnExplorer(address) {
            window.open(`https://etherscan.io/address/${address}`, '_blank');
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span style="font-size: 1.125rem;">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        // Close modal on outside click
        document.getElementById('walletModal').addEventListener('click', (e) => {
            if (e.target.id === 'walletModal') {
                closeWalletModal();
            }
        });
    </script>
</body>
</html>
